[{"id":"61d03d5d.622ad4","type":"tab","label":"API Farm Schedule Poller","disabled":false,"info":""},{"id":"83261835.d8a0a8","type":"tab","label":"Farm Schedule Writer","disabled":false,"info":""},{"id":"43378544.406b5c","type":"tab","label":"Irrigation Notifier","disabled":false,"info":""},{"id":"f4386468.5ef998","type":"tab","label":"Logged Irrigation Data Poster","disabled":false,"info":""},{"id":"a2d35a2c.16ee18","type":"tab","label":"Config Updater","disabled":false,"info":""},{"id":"7fae8053.0b7c1","type":"tab","label":"Valve Poller","disabled":false,"info":""},{"id":"4f42a725.2ee548","type":"tab","label":"Pump Poller","disabled":false,"info":""},{"id":"f4622989.27cb08","type":"tab","label":"EC Poller","disabled":false,"info":""},{"id":"12f51354.988b8d","type":"tab","label":"Irrigation Status Poller","disabled":false,"info":""},{"id":"c871d85e.04b1b8","type":"tab","label":"Water Usage Poller","disabled":false,"info":""},{"id":"689c1364.c8ce1c","type":"tab","label":"Time Update","disabled":false,"info":""},{"id":"f7c4e8ae.5b2308","type":"subflow","name":"Valve Modbus reader (Dummy)","info":"","category":"","in":[{"x":60,"y":320,"wires":[{"id":"fe0eceae.fcc48"},{"id":"f67007f0.4193e8"},{"id":"f4271fdc.35da"},{"id":"d1254e02.8db7"},{"id":"8777750a.b960e8"},{"id":"2e0486bb.7ba73a"},{"id":"2d29fa04.d7b016"},{"id":"a587b4b3.7175b8"},{"id":"b7474fc9.dbf31"}]}],"out":[{"x":1160,"y":320,"wires":[{"id":"ec42159b.976298","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"8746f1d.d50691","type":"subflow","name":"Read Pump Modbus","info":"","category":"","in":[{"x":60,"y":140,"wires":[{"id":"eb1a9902.b10b08"},{"id":"95f2ea48.fc78b8"},{"id":"82223775.e284b8"},{"id":"439a4e9a.30f1d"},{"id":"fd01c6e9.2880c8"},{"id":"3e6ca168.2a1b9e"}]}],"out":[{"x":1160,"y":320,"wires":[{"id":"6289da53.fd4654","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"9cc788df.bc1df8","type":"subflow","name":"READ Marker Bit Schneider","info":"Read a %M Marker Bit in a Schneider PLC","category":"","in":[{"x":240,"y":160,"wires":[{"id":"c04121f8.5eda1"}]}],"out":[{"x":600,"y":160,"wires":[{"id":"c04121f8.5eda1","port":0}]}],"env":[]},{"id":"bc940a84.af93b8","type":"subflow","name":"Read REAL Schneider ","info":"Converts the two 16 bit integer values from a Schneider PLC to REAL / Float value","category":"","in":[{"x":260,"y":200,"wires":[{"id":"6566bae5.df54a4"}]}],"out":[{"x":800,"y":200,"wires":[{"id":"128949af.f8d646","port":0}]}],"env":[]},{"id":"6c7475a9.a5471c","type":"subflow","name":"Write REAL Schneider","info":"Converts the float value input into 2 16 bit integers ","category":"","in":[{"x":120,"y":220,"wires":[{"id":"8fea9b83.211a78"}]}],"out":[{"x":700,"y":220,"wires":[{"id":"cb888e78.de25d","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"5c362c3f.f14494","type":"subflow","name":"Write Date","info":"","category":"","in":[{"x":40,"y":60,"wires":[{"id":"cbd09be1.fa65f8"}]}],"out":[{"x":560,"y":60,"wires":[{"id":"e7cfde77.ad281","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"1466200c.ef10b","type":"subflow","name":"Write Farm Schedule Modbus","info":"","category":"","in":[{"x":60,"y":180,"wires":[{"id":"544e13e6.ec2fbc"},{"id":"f155a1cb.82db8"},{"id":"e909bc82.522f9"},{"id":"58664e0a.c86dd"},{"id":"b2e301ad.f0bff"}]}],"out":[{"x":700,"y":180,"wires":[{"id":"40a1a0da.3d455","port":0}]},{"x":700,"y":240,"wires":[{"id":"5941d5f9.5b28ec","port":0}]},{"x":700,"y":300,"wires":[{"id":"b47fb608.ba8f18","port":0}]},{"x":700,"y":360,"wires":[{"id":"afba6c87.980ac","port":0}]},{"x":700,"y":420,"wires":[{"id":"b16eeedf.511d7","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ad856da8.1809a","type":"subflow","name":"Read Valve Modbus","info":"","category":"","in":[{"x":60,"y":320,"wires":[{"id":"849e985.1615768"},{"id":"41e10436.88d2cc"},{"id":"67882604.259f58"},{"id":"c82bad10.5027d"},{"id":"807af50.40dfc08"}]}],"out":[{"x":1180,"y":520,"wires":[{"id":"534d99da.cbac28","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"4609a12c.812e4","type":"subflow","name":"Round Float","info":"","category":"","in":[{"x":160,"y":160,"wires":[{"id":"1313ca4b.f7bee6"}]}],"out":[{"x":560,"y":160,"wires":[{"id":"1313ca4b.f7bee6","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"f51a93c4.92157","type":"subflow","name":"Timestamp","info":"","category":"","in":[{"x":200,"y":140,"wires":[{"id":"cd2b8627.23d428"}]}],"out":[{"x":740,"y":140,"wires":[{"id":"cd2b8627.23d428","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ac8f238.cc942e","type":"subflow","name":"Read EC Modbus","info":"","category":"","in":[{"x":40,"y":140,"wires":[{"id":"f42cca48.09b9c8"},{"id":"5565b796.20d918"},{"id":"f6c508d7.ee02c8"},{"id":"60ab3a62.b6a864"},{"id":"6286cdd4.1ae584"}]}],"out":[{"x":1120,"y":340,"wires":[{"id":"b5549f2d.326a","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ef3de703.f77228","type":"subflow","name":"Read Irrigation Status Modbus","info":"","category":"","in":[{"x":60,"y":200,"wires":[{"id":"c3214988.bcf398"},{"id":"80be9bc.6136468"},{"id":"62c8093d.a279b8"},{"id":"f9bdf815.640348"},{"id":"97309c7f.40642"},{"id":"d93876b7.977f08"},{"id":"66530530.6485bc"},{"id":"785ed13b.8ae71"}]}],"out":[{"x":1280,"y":420,"wires":[{"id":"7f3f916b.9b5a8","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"62fba3f4.438d0c","type":"subflow","name":"Read Water Usage Modbus","info":"","category":"","in":[{"x":40,"y":140,"wires":[{"id":"ff1c45a4.ebf858"},{"id":"1e717f04.c52ee1"},{"id":"ed3c7a18.b52398"},{"id":"4df57c32.d68514"}]}],"out":[{"x":1160,"y":380,"wires":[{"id":"99cced0f.12b3b","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"25f303f4.02b02c","type":"subflow","name":"Read Float Segment","info":"","category":"","in":[{"x":100,"y":80,"wires":[{"id":"6ec4fd73.ba20f4"}]}],"out":[{"x":600,"y":200,"wires":[{"id":"d7305bb3.f69708","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"4e66368c.aa1338","type":"subflow","name":"SET & RESET writing bits","info":"","category":"","in":[{"x":160,"y":140,"wires":[{"id":"3865e16.40b8c1e"}]}],"out":[{"x":840,"y":560,"wires":[{"id":"cf7d65db.f3ee38","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"f49ec726.13c968","type":"subflow","name":"Read Logged Irrigation Modbus","info":"","category":"","in":[{"x":60,"y":160,"wires":[{"id":"b8810245.80945"},{"id":"6c391ca5.5ec964"},{"id":"af17afc4.10738"},{"id":"22f15191.08808e"},{"id":"d8911a3a.7669d8"},{"id":"ca5e8aac.457338"},{"id":"6b0828e4.9a6fa8"}]}],"out":[{"x":1300,"y":420,"wires":[{"id":"f115ed1f.a8898","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"cec4e387.950ca","type":"mqtt-broker","name":"Siemens IoT2020 Gateway","broker":"192.168.0.104","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"763b0547.26ce3c","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey","palette":"light"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"64fb5e4d.38e0b","type":"ui_group","name":"Test","tab":"ebb21ec0.86402","order":1,"disp":true,"width":"6","collapse":false},{"id":"ebb21ec0.86402","type":"ui_tab","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"158a2db.8be95d2","type":"modbus-client","name":"M221","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"queueLogEnabled":false,"tcpHost":"192.168.1.126","tcpPort":"502","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","unit_id":"248","commandDelay":"1","clientTimeout":"1000","reconnectOnTimeout":true,"reconnectTimeout":"2000","parallelUnitIdsAllowed":false},{"id":"8da46fd8.ba1ca","type":"ui_group","name":"Configuration","tab":"ebb21ec0.86402","order":2,"disp":true,"width":"6","collapse":false},{"id":"fafb22ef.c351","type":"inject","z":"61d03d5d.622ad4","name":"Poll every few seconds","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"300","crontab":"","once":false,"onceDelay":"3","topic":"","payload":"","payloadType":"date","x":170,"y":80,"wires":[["2d85fb4a.8f3d84"]]},{"id":"2d85fb4a.8f3d84","type":"http request","z":"61d03d5d.622ad4","name":"GET farm API","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://lodicon-test-api.herokuapp.com/api/v1/-2147483551/MyFirstGateway/irrigation","tls":"","persist":false,"proxy":"","authType":"","x":160,"y":140,"wires":[["52501376.e1d4fc","c4cf8e27.9da8d","bd033857.7cd978","ad596e84.670ad","7539a2f.0c3655c"]]},{"id":"c4cf8e27.9da8d","type":"function","z":"61d03d5d.622ad4","name":"Orri 1-3","func":"msg.payload = msg.payload.find(f => f.field_name === \"Orri 1-3\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":240,"wires":[["27106ce.5450f94","c3adc3a3.83382"]]},{"id":"52501376.e1d4fc","type":"function","z":"61d03d5d.622ad4","name":"Eureka","func":"msg.payload = msg.payload.find(f => f.field_name === \"Eureka\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":200,"wires":[["6389cf93.a352a"]]},{"id":"bd033857.7cd978","type":"function","z":"61d03d5d.622ad4","name":"Orri 5","func":"msg.payload = msg.payload.find(f => f.field_name === \"Orri 5\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":410,"y":280,"wires":[["dde1e994.20d588"]]},{"id":"ad596e84.670ad","type":"function","z":"61d03d5d.622ad4","name":"Nadorcott 7-8","func":"msg.payload = msg.payload.find(f => f.field_name === \"Nadorcott 7-8\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":320,"wires":[["166fbef0.181ed1"]]},{"id":"7539a2f.0c3655c","type":"function","z":"61d03d5d.622ad4","name":"Nadorcott 6","func":"msg.payload = msg.payload.find(f => f.field_name === \"Nadorcott 6\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":430,"y":360,"wires":[["f9a4f064.5be0e"]]},{"id":"6389cf93.a352a","type":"link out","z":"61d03d5d.622ad4","name":"Eureka","links":["275bfcac.70c834","2ce6cd6f.0c2e12"],"x":615,"y":200,"wires":[]},{"id":"27106ce.5450f94","type":"link out","z":"61d03d5d.622ad4","name":"Orri 1-3","links":["21b6e91.02b5e16","92d88dfa.d6e9f"],"x":615,"y":240,"wires":[]},{"id":"166fbef0.181ed1","type":"link out","z":"61d03d5d.622ad4","name":"Nadorcott 7-8","links":["b68c7931.c97798","3b4f72d7.5d9c3e"],"x":615,"y":320,"wires":[]},{"id":"dde1e994.20d588","type":"link out","z":"61d03d5d.622ad4","name":"Orri 5","links":["19ab54.1be7c4ad"],"x":615,"y":280,"wires":[]},{"id":"f9a4f064.5be0e","type":"link out","z":"61d03d5d.622ad4","name":"Nadorcott 6","links":["9ffbc20a.a1ee3","f416cf9e.8c009"],"x":615,"y":360,"wires":[]},{"id":"168cb666.7cee5a","type":"comment","z":"61d03d5d.622ad4","name":"Repeats every 10 seconds","info":"","x":160,"y":40,"wires":[]},{"id":"fdf4fc25.bba66","type":"comment","z":"61d03d5d.622ad4","name":"Retrieve values for specific farms","info":"","x":490,"y":160,"wires":[]},{"id":"bc0860af.24b67","type":"inject","z":"7fae8053.0b7c1","name":"Valve Poller","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":160,"wires":[["8bd346fe.7f57b8","1c9cd78d.212668","410517eb.e528d8"]]},{"id":"4a843417.a68c5c","type":"join","z":"7fae8053.0b7c1","name":"Join sequence into array","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"3","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":910,"y":460,"wires":[["7e1a6ae3.561e04"]]},{"id":"45f44567.aae0cc","type":"debug","z":"7fae8053.0b7c1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1150,"y":560,"wires":[]},{"id":"7e1a6ae3.561e04","type":"json","z":"7fae8053.0b7c1","name":"Format to JSON","property":"payload","action":"obj","pretty":true,"x":920,"y":520,"wires":[["45f44567.aae0cc","e22e149b.4c76d8"]]},{"id":"6c14d2b0.89acac","type":"comment","z":"7fae8053.0b7c1","name":"Set valve count here","info":"","x":890,"y":400,"wires":[]},{"id":"c3adc3a3.83382","type":"debug","z":"61d03d5d.622ad4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":690,"y":40,"wires":[]},{"id":"e22e149b.4c76d8","type":"http request","z":"7fae8053.0b7c1","name":"POST Valve data","method":"POST","ret":"txt","paytoqs":"ignore","url":"https://lodicon-test-api.herokuapp.com/api/v1/-2147483551/MyFirstGateway/valves","tls":"","persist":false,"proxy":"","authType":"","x":970,"y":580,"wires":[["45f44567.aae0cc"]]},{"id":"ec42159b.976298","type":"join","z":"f7c4e8ae.5b2308","name":"Join into an Object (with topics as keys)","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"9","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":920,"y":320,"wires":[[]]},{"id":"f67007f0.4193e8","type":"change","z":"f7c4e8ae.5b2308","name":"real_time_flow","rules":[{"t":"set","p":"payload","pt":"msg","to":"1.0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":200,"wires":[["563b5633.01a088"]]},{"id":"f4271fdc.35da","type":"change","z":"f7c4e8ae.5b2308","name":"real_time_flow_unit","rules":[{"t":"set","p":"payload","pt":"msg","to":"m³/h","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":240,"wires":[["f5ec44b7.0b3fe8"]]},{"id":"8777750a.b960e8","type":"change","z":"f7c4e8ae.5b2308","name":"total_flow","rules":[{"t":"set","p":"payload","pt":"msg","to":"1.0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":320,"wires":[["f6967969.0484d8"]]},{"id":"2e0486bb.7ba73a","type":"change","z":"f7c4e8ae.5b2308","name":"total_flow_unit","rules":[{"t":"set","p":"payload","pt":"msg","to":"m³/h","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":360,"wires":[["30cccc3f.94db44"]]},{"id":"fe0eceae.fcc48","type":"change","z":"f7c4e8ae.5b2308","name":"alarm","rules":[{"t":"set","p":"payload","pt":"msg","to":"No Alarm","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":160,"wires":[["f857d3b8.ef9f2"]]},{"id":"d1254e02.8db7","type":"change","z":"f7c4e8ae.5b2308","name":"status","rules":[{"t":"set","p":"payload","pt":"msg","to":"close","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":280,"wires":[["c57664cd.7cd8c8"]]},{"id":"2d29fa04.d7b016","type":"change","z":"f7c4e8ae.5b2308","name":"valve_type","rules":[{"t":"set","p":"payload","pt":"msg","to":"fertilizer valve","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":400,"wires":[["319cb8b.8322248"]]},{"id":"a587b4b3.7175b8","type":"change","z":"f7c4e8ae.5b2308","name":"timestamp","rules":[{"t":"set","p":"payload","pt":"msg","to":"$now()","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":480,"wires":[["22c39380.ce1a8c"]]},{"id":"51511db4.acddd4","type":"comment","z":"7fae8053.0b7c1","name":"Feed object structure here","info":"","x":350,"y":160,"wires":[]},{"id":"8bd346fe.7f57b8","type":"change","z":"7fae8053.0b7c1","name":"Fertilizer B (dummy)","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fertilizer B","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":280,"wires":[["c89840bf.e69c9"]]},{"id":"1c9cd78d.212668","type":"change","z":"7fae8053.0b7c1","name":"Backwash_Valve_01 (dummy)","rules":[{"t":"set","p":"payload","pt":"msg","to":"Backwash_Valve_01","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":340,"wires":[["c0ed8e2a.11f8c"]]},{"id":"c89840bf.e69c9","type":"subflow:f7c4e8ae.5b2308","z":"7fae8053.0b7c1","name":"","env":[],"x":650,"y":280,"wires":[["4a843417.a68c5c"]]},{"id":"c0ed8e2a.11f8c","type":"subflow:f7c4e8ae.5b2308","z":"7fae8053.0b7c1","name":"","env":[],"x":650,"y":340,"wires":[["4a843417.a68c5c"]]},{"id":"93637536.9a1bd8","type":"comment","z":"f7c4e8ae.5b2308","name":"Click to see explanation","info":"The input simply has the name of the valve as its payload, e.g. \"Fertilizer A\". At the prompt of the input, each of the Modbus getters reads its value and passes it in the message payload. We then set the topic of the message to the appropriate property, e.g. alarm or status.\n\nAfterwards, each of these messages are joined together by topic into one Object. The topic becomes the key and the payload becomes the value.\n\nIf any of the readers meet an error, they will return an undefined payload. If a payload is undefined, it is set as an empty string or 0.0, depending on the data type.","x":160,"y":60,"wires":[]},{"id":"b7474fc9.dbf31","type":"function","z":"f7c4e8ae.5b2308","name":"name","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":440,"wires":[["9e22795c.50ab88"]]},{"id":"f857d3b8.ef9f2","type":"function","z":"f7c4e8ae.5b2308","name":"alarm topic","func":"if (msg.payload === undefined){\n    msg.payload = \"\"\n}\nmsg.topic = \"alarm\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":160,"wires":[["ec42159b.976298"]]},{"id":"563b5633.01a088","type":"function","z":"f7c4e8ae.5b2308","name":"real_time_flow topic","func":"if (msg.payload === undefined){\n    msg.payload = 0.0\n}\nmsg.topic = \"real_time_flow\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":200,"wires":[["ec42159b.976298"]]},{"id":"f5ec44b7.0b3fe8","type":"function","z":"f7c4e8ae.5b2308","name":"real_time_flow_unit topic","func":"if (msg.payload === undefined){\n    msg.payload = \"\"\n}\nmsg.topic = \"real_time_flow_unit\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":240,"wires":[["ec42159b.976298"]]},{"id":"c57664cd.7cd8c8","type":"function","z":"f7c4e8ae.5b2308","name":"status topic","func":"if (msg.payload === undefined){\n    msg.payload = \"\"\n}\nmsg.topic = \"status\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":280,"wires":[["ec42159b.976298"]]},{"id":"f6967969.0484d8","type":"function","z":"f7c4e8ae.5b2308","name":"total_flow topic","func":"if (msg.payload === undefined){\n    msg.payload = 0.0\n}\nmsg.topic = \"total_flow\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":320,"wires":[["ec42159b.976298"]]},{"id":"30cccc3f.94db44","type":"function","z":"f7c4e8ae.5b2308","name":"total_flow_unit topic","func":"if (msg.payload === undefined){\n    msg.payload = \"\"\n}\nmsg.topic = \"total_flow_unit\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":360,"wires":[["ec42159b.976298"]]},{"id":"319cb8b.8322248","type":"function","z":"f7c4e8ae.5b2308","name":"valve_type topic","func":"if (msg.payload === undefined){\n    msg.payload = \"\"\n}\nmsg.topic = \"valve_type\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":400,"wires":[["ec42159b.976298"]]},{"id":"9e22795c.50ab88","type":"function","z":"f7c4e8ae.5b2308","name":"name topic","func":"\nmsg.topic = \"name\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":440,"wires":[["ec42159b.976298"]]},{"id":"22c39380.ce1a8c","type":"function","z":"f7c4e8ae.5b2308","name":"timestamp topic","func":"if (msg.payload === undefined){\n    msg.payload = \"\"\n}\nmsg.topic = \"timestamp\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":480,"wires":[["ec42159b.976298"]]},{"id":"233ad940.939fe6","type":"ui_form","z":"a2d35a2c.16ee18","name":"Configuration Form","label":"Configuration Form","group":"8da46fd8.ba1ca","order":0,"width":0,"height":0,"options":[{"label":"Valve field count","value":"valve_field_count","type":"number","required":false,"rows":null},{"label":"Valve fertilizer count","value":"valve_fertilizer_count","type":"number","required":false,"rows":null},{"label":"Valve backwash count","value":"valve_backwash_count","type":"number","required":false,"rows":null},{"label":"Pump main count","value":"pump_main_count","type":"number","required":false,"rows":null},{"label":"Pump booster count","value":"pump_booster_count","type":"number","required":false,"rows":null},{"label":"Pump backwash count","value":"pump_backwash_count","type":"number","required":false,"rows":null},{"label":"Soil moisture count","value":"soil_moisture_count","type":"number","required":false,"rows":null},{"label":"Level instruments count","value":"level_instruments_count","type":"number","required":false,"rows":null},{"label":"Valve main count","value":"valve_main_count","type":"number","required":false,"rows":null},{"label":"Placeholder 02 count","value":"placeholder_02_count","type":"number","required":false,"rows":null},{"label":"Placeholder 03 count","value":"placeholder_03_count","type":"number","required":false,"rows":null},{"label":"Placeholder 04 count","value":"placeholder_04_count","type":"number","required":false,"rows":null},{"label":"Placeholder 05 count","value":"placeholder_05_count","type":"number","required":false,"rows":null},{"label":"Field valve 01 name","value":"field_valve_01_name","type":"text","required":false,"rows":null},{"label":"Field valve 02 name","value":"field_valve_02_name","type":"text","required":false,"rows":null},{"label":"Field valve 03 name","value":"field_valve_03_name","type":"text","required":false,"rows":null},{"label":"Field valve 04 name","value":"field_valve_04_name","type":"text","required":false,"rows":null},{"label":"Field valve 05 name","value":"field_valve_05_name","type":"text","required":false,"rows":null},{"label":"Field valve 06 name","value":"field_valve_06_name","type":"text","required":false,"rows":null},{"label":"Field valve 07 name","value":"field_valve_07_name","type":"text","required":false,"rows":null},{"label":"Field valve 08 name","value":"field_valve_08_name","type":"text","required":false,"rows":null},{"label":"Field valve 09 name","value":"field_valve_09_name","type":"text","required":false,"rows":null},{"label":"Field valve 10 name","value":"field_valve_10_name","type":"text","required":false,"rows":null},{"label":"Field valve 11 name","value":"field_valve_11_name","type":"text","required":false,"rows":null},{"label":"Field valve 12 name","value":"field_valve_12_name","type":"text","required":false,"rows":null},{"label":"Field valve 13 name","value":"field_valve_13_name","type":"text","required":false,"rows":null},{"label":"Field valve 14 name","value":"field_valve_14_name","type":"text","required":false,"rows":null},{"label":"Field valve 15 name","value":"field_valve_15_name","type":"text","required":false,"rows":null},{"label":"Field valve 16 name","value":"field_valve_16_name","type":"text","required":false,"rows":null},{"label":"Field valve 17 name","value":"field_valve_17_name","type":"text","required":false,"rows":null},{"label":"Field valve 18 name","value":"field_valve_18_name","type":"text","required":false,"rows":null},{"label":"Field valve 19 name","value":"field_valve_19_name","type":"text","required":false,"rows":null},{"label":"Field valve 20 name","value":"field_valve_20_name","type":"text","required":false,"rows":null},{"label":"Field valve 21 name","value":"field_valve_21_name","type":"text","required":false,"rows":null},{"label":"Field valve 22 name","value":"field_valve_22_name","type":"text","required":false,"rows":null},{"label":"Field valve 23 name","value":"field_valve_23_name","type":"text","required":false,"rows":null},{"label":"Field valve 24 name","value":"field_valve_24_name","type":"text","required":false,"rows":null},{"label":"Field valve 25 name","value":"field_valve_25_name","type":"text","required":false,"rows":null},{"label":"Field valve 26 name","value":"field_valve_26_name","type":"text","required":false,"rows":null},{"label":"Field valve 27 name","value":"field_valve_27_name","type":"text","required":false,"rows":null},{"label":"Field valve 28 name","value":"field_valve_28_name","type":"text","required":false,"rows":null},{"label":"Field valve 29 name","value":"field_valve_29_name","type":"text","required":false,"rows":null},{"label":"Field valve 30 name","value":"field_valve_30_name","type":"text","required":false,"rows":null},{"label":"Field valve 31 name","value":"field_valve_31_name","type":"text","required":false,"rows":null},{"label":"Field valve 32 name","value":"field_valve_32_name","type":"text","required":false,"rows":null},{"label":"Field valve 33 name","value":"field_valve_33_name","type":"text","required":false,"rows":null},{"label":"Field valve 34 name","value":"field_valve_34_name","type":"text","required":false,"rows":null},{"label":"Field valve 35 name","value":"field_valve_35_name","type":"text","required":false,"rows":null},{"label":"Field valve 36 name","value":"field_valve_36_name","type":"text","required":false,"rows":null},{"label":"Field valve 37 name","value":"field_valve_37_name","type":"text","required":false,"rows":null},{"label":"Field valve 38 name","value":"field_valve_38_name","type":"text","required":false,"rows":null},{"label":"Field valve 39 name","value":"field_valve_39_name","type":"text","required":false,"rows":null},{"label":"Field valve 40 name","value":"field_valve_40_name","type":"text","required":false,"rows":null},{"label":"Field valve 41 name","value":"field_valve_41_name","type":"text","required":false,"rows":null},{"label":"Field valve 42 name","value":"field_valve_42_name","type":"text","required":false,"rows":null},{"label":"Field valve 43 name","value":"field_valve_43_name","type":"text","required":false,"rows":null},{"label":"Field valve 44 name","value":"field_valve_44_name","type":"text","required":false,"rows":null},{"label":"Field valve 45 name","value":"field_valve_45_name","type":"text","required":false,"rows":null},{"label":"Field valve 46 name","value":"field_valve_46_name","type":"text","required":false,"rows":null},{"label":"Field valve 47 name","value":"field_valve_47_name","type":"text","required":false,"rows":null},{"label":"Field valve 48 name","value":"field_valve_48_name","type":"text","required":false,"rows":null},{"label":"Field valve 49 name","value":"field_valve_49_name","type":"text","required":false,"rows":null},{"label":"Field valve 50 name","value":"field_valve_50_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 01 name","value":"fertilizer_valve_01_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 02 name","value":"fertilizer_valve_02_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 03 name","value":"fertilizer_valve_03_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 04 name","value":"fertilizer_valve_04_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 05 name","value":"fertilizer_valve_05_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 06 name","value":"fertilizer_valve_06_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 07 name","value":"fertilizer_valve_07_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 08 name","value":"fertilizer_valve_08_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 09 name","value":"fertilizer_valve_09_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 10 name","value":"fertilizer_valve_10_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 11 name","value":"fertilizer_valve_11_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 12 name","value":"fertilizer_valve_12_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 13 name","value":"fertilizer_valve_13_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 14 name","value":"fertilizer_valve_14_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 15 name","value":"fertilizer_valve_15_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 16 name","value":"fertilizer_valve_16_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 17 name","value":"fertilizer_valve_17_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 18 name","value":"fertilizer_valve_18_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 19 name","value":"fertilizer_valve_19_name","type":"text","required":false,"rows":null},{"label":"Fertilizer valve 20 name","value":"fertilizer_valve_20_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 01 name","value":"backwash_valve_01_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 02 name","value":"backwash_valve_02_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 03 name","value":"backwash_valve_03_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 04 name","value":"backwash_valve_04_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 05 name","value":"backwash_valve_05_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 06 name","value":"backwash_valve_06_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 07 name","value":"backwash_valve_07_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 08 name","value":"backwash_valve_08_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 09 name","value":"backwash_valve_09_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 10 name","value":"backwash_valve_10_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 11 name","value":"backwash_valve_11_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 12 name","value":"backwash_valve_12_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 13 name","value":"backwash_valve_13_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 14 name","value":"backwash_valve_14_name","type":"text","required":false,"rows":null},{"label":"Backwash valve 15 name","value":"backwash_valve_15_name","type":"text","required":false,"rows":null},{"label":"Main pump 01 name","value":"main_pump_01_name","type":"text","required":false,"rows":null},{"label":"Main pump 02 name","value":"main_pump_02_name","type":"text","required":false,"rows":null},{"label":"Main pump 03 name","value":"main_pump_03_name","type":"text","required":false,"rows":null},{"label":"Main pump 04 name","value":"main_pump_04_name","type":"text","required":false,"rows":null},{"label":"Main pump 05 name","value":"main_pump_05_name","type":"text","required":false,"rows":null},{"label":"Backwash pump 01 name","value":"backwash_pump_01_name","type":"text","required":false,"rows":null},{"label":"Backwash pump 02 name","value":"backwash_pump_02_name","type":"text","required":false,"rows":null},{"label":"Backwash pump 03 name","value":"backwash_pump_03_name","type":"text","required":false,"rows":null},{"label":"Backwash pump 04 name","value":"backwash_pump_04_name","type":"text","required":false,"rows":null},{"label":"Backwash pump 05 name","value":"backwash_pump_05_name","type":"text","required":false,"rows":null},{"label":"Booster pump 01 name","value":"booster_pump_01_name","type":"text","required":false,"rows":null},{"label":"Booster pump 02 name","value":"booster_pump_02_name","type":"text","required":false,"rows":null},{"label":"Booster pump 03 name","value":"booster_pump_03_name","type":"text","required":false,"rows":null},{"label":"Booster pump 04 name","value":"booster_pump_04_name","type":"text","required":false,"rows":null},{"label":"Booster pump 05 name","value":"booster_pump_05_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 01 name","value":"soil_moisture_01_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 02 name","value":"soil_moisture_02_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 03 name","value":"soil_moisture_03_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 04 name","value":"soil_moisture_04_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 05 name","value":"soil_moisture_05_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 06 name","value":"soil_moisture_06_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 07 name","value":"soil_moisture_07_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 08 name","value":"soil_moisture_08_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 09 name","value":"soil_moisture_09_name","type":"text","required":false,"rows":null},{"label":"Soil moisture 10 name","value":"soil_moisture_10_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 01 name","value":"level_transmitter_01_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 02 name","value":"level_transmitter_02_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 03 name","value":"level_transmitter_03_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 04 name","value":"level_transmitter_04_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 05 name","value":"level_transmitter_05_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 06 name","value":"level_transmitter_06_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 07 name","value":"level_transmitter_07_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 08 name","value":"level_transmitter_08_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 09 name","value":"level_transmitter_09_name","type":"text","required":false,"rows":null},{"label":"Level transmitter 10 name","value":"level_transmitter_10_name","type":"text","required":false,"rows":null},{"label":"Main valve 01 name","value":"main_valve_01_name","type":"text","required":false,"rows":null},{"label":"Main valve 02 name","value":"main_valve_02_name","type":"text","required":false,"rows":null},{"label":"Main valve 03 name","value":"main_valve_03_name","type":"text","required":false,"rows":null},{"label":"Main valve 04 name","value":"main_valve_04_name","type":"text","required":false,"rows":null},{"label":"Main valve 05 name","value":"main_valve_05_name","type":"text","required":false,"rows":null}],"formValue":{"valve_field_count":"","valve_fertilizer_count":"","valve_backwash_count":"","pump_main_count":"","pump_booster_count":"","pump_backwash_count":"","soil_moisture_count":"","level_instruments_count":"","valve_main_count":"","placeholder_02_count":"","placeholder_03_count":"","placeholder_04_count":"","placeholder_05_count":"","field_valve_01_name":"","field_valve_02_name":"","field_valve_03_name":"","field_valve_04_name":"","field_valve_05_name":"","field_valve_06_name":"","field_valve_07_name":"","field_valve_08_name":"","field_valve_09_name":"","field_valve_10_name":"","field_valve_11_name":"","field_valve_12_name":"","field_valve_13_name":"","field_valve_14_name":"","field_valve_15_name":"","field_valve_16_name":"","field_valve_17_name":"","field_valve_18_name":"","field_valve_19_name":"","field_valve_20_name":"","field_valve_21_name":"","field_valve_22_name":"","field_valve_23_name":"","field_valve_24_name":"","field_valve_25_name":"","field_valve_26_name":"","field_valve_27_name":"","field_valve_28_name":"","field_valve_29_name":"","field_valve_30_name":"","field_valve_31_name":"","field_valve_32_name":"","field_valve_33_name":"","field_valve_34_name":"","field_valve_35_name":"","field_valve_36_name":"","field_valve_37_name":"","field_valve_38_name":"","field_valve_39_name":"","field_valve_40_name":"","field_valve_41_name":"","field_valve_42_name":"","field_valve_43_name":"","field_valve_44_name":"","field_valve_45_name":"","field_valve_46_name":"","field_valve_47_name":"","field_valve_48_name":"","field_valve_49_name":"","field_valve_50_name":"","fertilizer_valve_01_name":"","fertilizer_valve_02_name":"","fertilizer_valve_03_name":"","fertilizer_valve_04_name":"","fertilizer_valve_05_name":"","fertilizer_valve_06_name":"","fertilizer_valve_07_name":"","fertilizer_valve_08_name":"","fertilizer_valve_09_name":"","fertilizer_valve_10_name":"","fertilizer_valve_11_name":"","fertilizer_valve_12_name":"","fertilizer_valve_13_name":"","fertilizer_valve_14_name":"","fertilizer_valve_15_name":"","fertilizer_valve_16_name":"","fertilizer_valve_17_name":"","fertilizer_valve_18_name":"","fertilizer_valve_19_name":"","fertilizer_valve_20_name":"","backwash_valve_01_name":"","backwash_valve_02_name":"","backwash_valve_03_name":"","backwash_valve_04_name":"","backwash_valve_05_name":"","backwash_valve_06_name":"","backwash_valve_07_name":"","backwash_valve_08_name":"","backwash_valve_09_name":"","backwash_valve_10_name":"","backwash_valve_11_name":"","backwash_valve_12_name":"","backwash_valve_13_name":"","backwash_valve_14_name":"","backwash_valve_15_name":"","main_pump_01_name":"","main_pump_02_name":"","main_pump_03_name":"","main_pump_04_name":"","main_pump_05_name":"","backwash_pump_01_name":"","backwash_pump_02_name":"","backwash_pump_03_name":"","backwash_pump_04_name":"","backwash_pump_05_name":"","booster_pump_01_name":"","booster_pump_02_name":"","booster_pump_03_name":"","booster_pump_04_name":"","booster_pump_05_name":"","soil_moisture_01_name":"","soil_moisture_02_name":"","soil_moisture_03_name":"","soil_moisture_04_name":"","soil_moisture_05_name":"","soil_moisture_06_name":"","soil_moisture_07_name":"","soil_moisture_08_name":"","soil_moisture_09_name":"","soil_moisture_10_name":"","level_transmitter_01_name":"","level_transmitter_02_name":"","level_transmitter_03_name":"","level_transmitter_04_name":"","level_transmitter_05_name":"","level_transmitter_06_name":"","level_transmitter_07_name":"","level_transmitter_08_name":"","level_transmitter_09_name":"","level_transmitter_10_name":"","main_valve_01_name":"","main_valve_02_name":"","main_valve_03_name":"","main_valve_04_name":"","main_valve_05_name":""},"payload":"","submit":"submit","cancel":"cancel","topic":"topic","topicType":"msg","splitLayout":false,"x":250,"y":220,"wires":[["9816f318.af584"]]},{"id":"763fbef0.17a8f","type":"inject","z":"a2d35a2c.16ee18","name":"Click to update configuration","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":100,"wires":[["620af06e.bd6f5"]]},{"id":"620af06e.bd6f5","type":"http request","z":"a2d35a2c.16ee18","name":"Retrieve current config","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://lodicon-test-api.herokuapp.com/api/v1/-2147483551/ChrisKim/config_update","tls":"","persist":false,"proxy":"","authType":"","x":220,"y":160,"wires":[["233ad940.939fe6"]]},{"id":"9816f318.af584","type":"http request","z":"a2d35a2c.16ee18","name":"POST new config","method":"POST","ret":"txt","paytoqs":"ignore","url":"https://lodicon-test-api.herokuapp.com/api/v1/-2147483551/ChrisKim/config_update","tls":"","persist":false,"proxy":"","authType":"","x":290,"y":280,"wires":[["49cb0f49.66a42"]]},{"id":"7585bd1f.be00c4","type":"ui_toast","z":"a2d35a2c.16ee18","position":"top right","displayTime":"3","highlight":"","sendall":true,"outputs":0,"ok":"OK","cancel":"","raw":false,"topic":"","name":"Notify","x":330,"y":400,"wires":[]},{"id":"49cb0f49.66a42","type":"function","z":"a2d35a2c.16ee18","name":"Check if successful","func":"if (msg.statusCode === 200){\n    msg.payload = \"Update successful!\"\n}\nelse {\n    msg.payload = \"Update failed.\"\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":340,"wires":[["7585bd1f.be00c4","620af06e.bd6f5"]]},{"id":"c04121f8.5eda1","type":"function","z":"9cc788df.bc1df8","name":"Read Marker Bit Schneider","func":"var bit1 = msg.payload[0]\n//msg.payload = bit1.toString();\nmsg.payload = Boolean(bit1)\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":160,"wires":[[]]},{"id":"54da51a.8a510b","type":"comment","z":"9cc788df.bc1df8","name":"Read %M Marker Bit values over Modbus TCP from Schneider PLC","info":"Read %M Marker Bit values over Modbus TCP from Schneider PLC","x":460,"y":120,"wires":[]},{"id":"128949af.f8d646","type":"toFloat","z":"bc940a84.af93b8","name":"","toFixed":"","x":690,"y":200,"wires":[[]]},{"id":"6566bae5.df54a4","type":"function","z":"bc940a84.af93b8","name":"Read REAL From Schneider PLC","func":"msg.payload = (msg.payload[1]<<16) + msg.payload[0]\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":200,"wires":[["128949af.f8d646"]]},{"id":"2bd484b9.4ac3ac","type":"comment","z":"bc940a84.af93b8","name":"Read REAL values over Modbus TCP from Schneider PLC","info":"Read REAL values over Modbus TCP from Schneider PLC","x":550,"y":160,"wires":[]},{"id":"8fea9b83.211a78","type":"function","z":"6c7475a9.a5471c","name":"Write REAL to Schneider PLC","func":"var x = msg.payload;\nvar y = 0;\nvar z = 0;\n\n[x,y] = new Uint16Array(new Float32Array([x]).buffer);\nmsg.payload = [x, y]\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":220,"wires":[["cb888e78.de25d"]]},{"id":"14109161.49a82f","type":"comment","z":"6c7475a9.a5471c","name":"Write REAL values over Modbus TCP to Schneider PLC","info":"Write REAL values over Modbus TCP to Schneider PLC","x":300,"y":180,"wires":[]},{"id":"2ce6cd6f.0c2e12","type":"link in","z":"83261835.d8a0a8","name":"Eureka","links":["6389cf93.a352a"],"x":275,"y":220,"wires":[["bb5bb2cc.b88d9"]]},{"id":"17d5505f.2e4af","type":"modbus-flex-write","z":"83261835.d8a0a8","name":"","showStatusActivities":true,"showErrors":true,"server":"158a2db.8be95d2","emptyMsgOnFail":false,"keepMsgProperties":false,"x":930,"y":460,"wires":[["1c2b542d.1feebc"],[]]},{"id":"cbd09be1.fa65f8","type":"function","z":"5c362c3f.f14494","name":"Date formatter","func":"const date = new Date(msg.payload)\nvar registrationSegment = [\n    date.getFullYear(),\n    date.getMonth() + 1, //Javascript Date months range from 0 to 11; we must add 1 to adjust\n    date.getDate(),\n    date.getHours(),\n    date.getMinutes()\n    ]\nmsg.payload = registrationSegment;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":60,"wires":[["e7cfde77.ad281"]],"info":"Takes as its input a date payload in the following ISO Date format:\nYYYY-mm-ddThh:mm:ss"},{"id":"e7cfde77.ad281","type":"function","z":"5c362c3f.f14494","name":"Modbus overhead","func":"msg.payload = {\n    value: msg.payload,\n    'fc': 16,\n    'address': msg.block_addr + msg.attribute_offset,\n    'quantity': 5\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":60,"wires":[[]]},{"id":"40a1a0da.3d455","type":"subflow:5c362c3f.f14494","z":"1466200c.ef10b","name":"","env":[],"x":490,"y":180,"wires":[[]]},{"id":"544e13e6.ec2fbc","type":"function","z":"1466200c.ef10b","name":"start_time","func":"msg.payload = msg.payload.start_time;\nmsg.attribute_offset = 0;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":180,"wires":[["40a1a0da.3d455"]],"info":"called BLOCK1_START_TIME_X in PLC configuration,\nwhere X indicates date attribute, eg. Y for year"},{"id":"f155a1cb.82db8","type":"function","z":"1466200c.ef10b","name":"end_time","func":"msg.payload = msg.payload.end_time;\nmsg.attribute_offset = 7\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":240,"wires":[["5941d5f9.5b28ec"]],"info":"called BLOCK1_END_TIME_X in PLC configuration,\nwhere X indicates date attribute, eg. Y for year"},{"id":"5941d5f9.5b28ec","type":"subflow:5c362c3f.f14494","z":"1466200c.ef10b","name":"","env":[],"x":490,"y":240,"wires":[[]]},{"id":"e909bc82.522f9","type":"function","z":"1466200c.ef10b","name":"irrigenrichecmicroszcm","func":"msg.payload = msg.payload.irrigenrichecmicroszcm;\nmsg.attribute_offset = 12;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":300,"wires":[["b47fb608.ba8f18"]],"info":"called BLOCK1_EC_SP_REAL in PLC configuration"},{"id":"b47fb608.ba8f18","type":"subflow:6c7475a9.a5471c","z":"1466200c.ef10b","name":"","env":[],"x":520,"y":300,"wires":[[]]},{"id":"58664e0a.c86dd","type":"function","z":"1466200c.ef10b","name":"irrigation_time_minutes","func":"msg.payload = msg.payload.irrigation_time_minutes;\nmsg.attribute_offset = 14;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":360,"wires":[["afba6c87.980ac"]],"info":"called BLOCK1_RUNTIME_MN in PLC configuration"},{"id":"afba6c87.980ac","type":"subflow:6c7475a9.a5471c","z":"1466200c.ef10b","name":"","env":[],"x":520,"y":360,"wires":[[]]},{"id":"cb888e78.de25d","type":"function","z":"6c7475a9.a5471c","name":"Modbus overhead","func":"msg.payload = {\n    value: msg.payload,\n    'fc': 16,\n    'address': msg.block_addr + msg.attribute_offset,\n    'quantity': 2\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":220,"wires":[[]]},{"id":"b2e301ad.f0bff","type":"function","z":"1466200c.ef10b","name":"ferttanklzm3_XX","func":"msg.payload = [\n    msg.payload.ferttanklzm3_01,\n    msg.payload.ferttanklzm3_02,\n    msg.payload.ferttanklzm3_03,\n    msg.payload.ferttanklzm3_04,\n    msg.payload.ferttanklzm3_05,\n    msg.payload.ferttanklzm3_06,\n    msg.payload.ferttanklzm3_07,\n    msg.payload.ferttanklzm3_08,\n    msg.payload.ferttanklzm3_09,\n    msg.payload.ferttanklzm3_10,\n    ];\nmsg.attribute_offset = 16;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":420,"wires":[["b16eeedf.511d7"]]},{"id":"6c0cc62b.62ddf8","type":"subflow:1466200c.ef10b","z":"83261835.d8a0a8","name":"","env":[],"x":630,"y":260,"wires":[["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"]]},{"id":"b16eeedf.511d7","type":"function","z":"1466200c.ef10b","name":"Write Fertilizer Floats","func":"const toInt16 = function(x) {\n    [x,y] = new Uint16Array(new Float32Array([x]).buffer);\n    return [x, y];\n}\n\nconst toInt16Array = function(floatArray) {\n    var int16Array = [];\n    for (let i=0; i<floatArray.length; i++){\n        int16Array.push(...toInt16(floatArray[i]));\n    }\n    return int16Array;\n}\n\nmsg.payload = {\n    value: toInt16Array(msg.payload),\n    'fc': 16,\n    'address': msg.block_addr + msg.attribute_offset,\n    'quantity': 20\n    };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":420,"wires":[[]]},{"id":"bb5bb2cc.b88d9","type":"change","z":"83261835.d8a0a8","name":"Eureka: set block_addr to 1000","rules":[{"t":"set","p":"block_addr","pt":"msg","to":"1000","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":260,"wires":[["6c0cc62b.62ddf8"]],"info":"Can be found as BLOCK1 in PLC"},{"id":"1c2b542d.1feebc","type":"debug","z":"83261835.d8a0a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1130,"y":360,"wires":[]},{"id":"7e35b1b3.0bd42","type":"subflow:1466200c.ef10b","z":"83261835.d8a0a8","name":"","env":[],"x":630,"y":360,"wires":[["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"]]},{"id":"76888cb.e54ff74","type":"subflow:1466200c.ef10b","z":"83261835.d8a0a8","name":"","x":630,"y":460,"wires":[["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"]]},{"id":"ad37f9a9.28c0f8","type":"subflow:1466200c.ef10b","z":"83261835.d8a0a8","name":"","x":630,"y":560,"wires":[["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"]]},{"id":"c2dba2d1.4631c","type":"subflow:1466200c.ef10b","z":"83261835.d8a0a8","name":"","x":630,"y":660,"wires":[["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"],["17d5505f.2e4af"]]},{"id":"92d88dfa.d6e9f","type":"link in","z":"83261835.d8a0a8","name":"Orri 1-3","links":["27106ce.5450f94"],"x":275,"y":320,"wires":[["82ad8ecf.0fd74"]]},{"id":"3b4f72d7.5d9c3e","type":"link in","z":"83261835.d8a0a8","name":"Nadorcott 7-8","links":["166fbef0.181ed1"],"x":275,"y":520,"wires":[["d1dcedb7.3d647"]]},{"id":"19ab54.1be7c4ad","type":"link in","z":"83261835.d8a0a8","name":"Orri 5","links":["dde1e994.20d588"],"x":275,"y":420,"wires":[["8cbdf7be.c77218"]]},{"id":"f416cf9e.8c009","type":"link in","z":"83261835.d8a0a8","name":"Nadorcott 6","links":["f9a4f064.5be0e"],"x":275,"y":620,"wires":[["990b3adf.a34e58"]]},{"id":"82ad8ecf.0fd74","type":"change","z":"83261835.d8a0a8","name":"Orri 1-3: set block_addr to 1051","rules":[{"t":"set","p":"block_addr","pt":"msg","to":"1051","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":360,"wires":[["7e35b1b3.0bd42"]],"info":"Can be found as BLOCK2 in PLC"},{"id":"8cbdf7be.c77218","type":"change","z":"83261835.d8a0a8","name":"Orri 5: set block_addr to 1102","rules":[{"t":"set","p":"block_addr","pt":"msg","to":"1102","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":460,"wires":[["76888cb.e54ff74"]],"info":"Can be found as BLOCK3 in PLC"},{"id":"d1dcedb7.3d647","type":"change","z":"83261835.d8a0a8","name":"Nadorcott 7-8: set block_addr to 1153","rules":[{"t":"set","p":"block_addr","pt":"msg","to":"1153","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":560,"wires":[["ad37f9a9.28c0f8"]],"info":"Can be found as BLOCK4 in PLC"},{"id":"990b3adf.a34e58","type":"change","z":"83261835.d8a0a8","name":" Nadorcott 6: set block_addr to 1204","rules":[{"t":"set","p":"block_addr","pt":"msg","to":"1204","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":660,"wires":[["c2dba2d1.4631c"]],"info":"Can be found as BLOCK5 in PLC"},{"id":"534d99da.cbac28","type":"join","z":"ad856da8.1809a","name":"Join into an Object (with topics as keys)","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"9","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":940,"y":520,"wires":[[]]},{"id":"849e985.1615768","type":"function","z":"ad856da8.1809a","name":"Pass on other properties","func":"msg.payload = {\n    'name': msg.payload.name,\n    'timestamp': msg.payload.timestamp,\n    'valve_type': msg.payload.valve_type,\n    'real_time_flow_unit': msg.payload.real_time_flow_unit,\n    'total_flow_unit': msg.payload.total_flow_unit\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":520,"wires":[["8dd64b1.630e7b8"]]},{"id":"41e10436.88d2cc","type":"function","z":"ad856da8.1809a","name":"alarm","func":"const offset = 0;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 1\n}\nmsg.topic = 'alarm'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":260,"wires":[["27af82dc.e6e7ce"]]},{"id":"27af82dc.e6e7ce","type":"modbus-flex-getter","z":"ad856da8.1809a","name":"","showStatusActivities":true,"showErrors":true,"logIOActivities":false,"server":"158a2db.8be95d2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":true,"x":490,"y":280,"wires":[["4026df00.d553b"],[]]},{"id":"67882604.259f58","type":"function","z":"ad856da8.1809a","name":"status","func":"const offset = 1;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 1\n}\nmsg.topic = 'status'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":300,"wires":[["27af82dc.e6e7ce"]]},{"id":"c82bad10.5027d","type":"function","z":"ad856da8.1809a","name":"real_time_flow","func":"const offset = 4;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'real_time_flow'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":380,"wires":[["27af82dc.e6e7ce"]]},{"id":"807af50.40dfc08","type":"function","z":"ad856da8.1809a","name":"total_flow","func":"const offset = 2;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 1\n}\nmsg.topic = 'total_flow'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":340,"wires":[["27af82dc.e6e7ce"]]},{"id":"4026df00.d553b","type":"switch","z":"ad856da8.1809a","name":"Handle floats separately","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"real_time_flow","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":550,"y":360,"wires":[["f14bb95d.6c8088"],["1a3892a5.19553d"]]},{"id":"1a3892a5.19553d","type":"function","z":"ad856da8.1809a","name":"Read INT Schneider","func":"msg.payload = msg.payload[0];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":380,"wires":[["534d99da.cbac28"]]},{"id":"f14bb95d.6c8088","type":"subflow:bc940a84.af93b8","z":"ad856da8.1809a","name":"","env":[],"x":800,"y":340,"wires":[["43fb736b.c1cc5c"]]},{"id":"410517eb.e528d8","type":"function","z":"7fae8053.0b7c1","name":"Fertilizer A: block_addr=2000","func":"msg.payload = {\n    alarm: 0,\n    real_time_flow: 0,\n    real_time_flow_unit: \"m³/h\",\n    status: 0,\n    total_flow: 1,\n    total_flow_unit: \"m³/h\",\n    valve_type: \"fertilizer valve\",\n    name: \"Fertilizer A\",\n    timestamp: \"\"\n}\nmsg.block_addr = 2000;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":220,"wires":[["d3fc9997.16fa28"]]},{"id":"d3fc9997.16fa28","type":"subflow:ad856da8.1809a","z":"7fae8053.0b7c1","name":"","env":[],"x":680,"y":220,"wires":[["4a843417.a68c5c"]]},{"id":"e56a21f3.f23d7","type":"split","z":"ad856da8.1809a","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":670,"y":520,"wires":[["534d99da.cbac28"]]},{"id":"1313ca4b.f7bee6","type":"function","z":"4609a12c.812e4","name":"Round to 3 decimal places","func":"msg.payload = Math.round(msg.payload * 1000) / 1000\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":160,"wires":[[]]},{"id":"43fb736b.c1cc5c","type":"subflow:4609a12c.812e4","z":"ad856da8.1809a","name":"","env":[],"x":990,"y":340,"wires":[["534d99da.cbac28"]]},{"id":"8dd64b1.630e7b8","type":"subflow:f51a93c4.92157","z":"ad856da8.1809a","name":"","env":[],"x":520,"y":520,"wires":[["e56a21f3.f23d7"]]},{"id":"6289da53.fd4654","type":"join","z":"8746f1d.d50691","name":"Join into an Object (with topics as keys)","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"11","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":900,"y":320,"wires":[[]]},{"id":"eb1a9902.b10b08","type":"function","z":"8746f1d.d50691","name":"Pass on other properties","func":"msg.payload = {\n    'name': msg.payload.name,\n    'timestamp': msg.payload.timestamp,\n    'valve_type': msg.payload.valve_type,\n    'real_time_flow_unit': msg.payload.real_time_flow_unit,\n    'real_time_pressure_unit': msg.payload.real_time_pressure_unit,\n    'total_flow_unit': msg.payload.total_flow_unit,\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":320,"wires":[["c226b28f.42b4"]]},{"id":"fd01c6e9.2880c8","type":"function","z":"8746f1d.d50691","name":"alarm","func":"const offset = 0;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 1\n}\nmsg.topic = 'alarm'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":60,"wires":[["f221c9c8.831858"]]},{"id":"f221c9c8.831858","type":"modbus-flex-getter","z":"8746f1d.d50691","name":"","showStatusActivities":true,"showErrors":true,"logIOActivities":false,"server":"158a2db.8be95d2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":true,"x":450,"y":80,"wires":[["6d31d177.450b9"],[]]},{"id":"439a4e9a.30f1d","type":"function","z":"8746f1d.d50691","name":"real_time_flow","func":"const offset = 4;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'real_time_flow'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":180,"wires":[["f221c9c8.831858"]]},{"id":"95f2ea48.fc78b8","type":"function","z":"8746f1d.d50691","name":"total_flow","func":"const offset = 2;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 1\n}\nmsg.topic = 'total_flow'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":140,"wires":[["f221c9c8.831858"]]},{"id":"6d31d177.450b9","type":"switch","z":"8746f1d.d50691","name":"Handle floats separately","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"real_time_flow","vt":"str"},{"t":"eq","v":"real_time_pressure","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":510,"y":160,"wires":[["f808f5e0.e04608"],["f808f5e0.e04608"],["6555073b.c72be8"]]},{"id":"6555073b.c72be8","type":"function","z":"8746f1d.d50691","name":"Read INT Schneider","func":"msg.payload = msg.payload[0];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":760,"y":180,"wires":[["6289da53.fd4654"]]},{"id":"f808f5e0.e04608","type":"subflow:bc940a84.af93b8","z":"8746f1d.d50691","name":"","env":[],"x":760,"y":140,"wires":[["fab6cafb.5d9fc8"]]},{"id":"7f1257c5.20c4b8","type":"split","z":"8746f1d.d50691","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":610,"y":320,"wires":[["6289da53.fd4654"]]},{"id":"fab6cafb.5d9fc8","type":"subflow:4609a12c.812e4","z":"8746f1d.d50691","name":"","env":[],"x":950,"y":140,"wires":[["6289da53.fd4654"]]},{"id":"c226b28f.42b4","type":"subflow:f51a93c4.92157","z":"8746f1d.d50691","name":"","env":[],"x":480,"y":320,"wires":[["7f1257c5.20c4b8"]]},{"id":"82223775.e284b8","type":"function","z":"8746f1d.d50691","name":"real_time_pressure","func":"const offset = 6;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'real_time_pressure'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":220,"wires":[["f221c9c8.831858"]]},{"id":"de8d2b3d.349098","type":"inject","z":"4f42a725.2ee548","name":"Pump Poller","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":80,"wires":[["cfe9dca6.781eb","9093532e.71629"]]},{"id":"3cf100c1.7f74d","type":"join","z":"4f42a725.2ee548","name":"Join sequence into array","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":910,"y":380,"wires":[["9751a766.47af68"]]},{"id":"194f35f7.4d8f3a","type":"debug","z":"4f42a725.2ee548","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1150,"y":480,"wires":[]},{"id":"9751a766.47af68","type":"json","z":"4f42a725.2ee548","name":"Format to JSON","property":"payload","action":"obj","pretty":true,"x":920,"y":440,"wires":[["194f35f7.4d8f3a","54b7e03f.b54cc"]]},{"id":"dc6360a5.1f06d","type":"comment","z":"4f42a725.2ee548","name":"Set pump count here","info":"","x":890,"y":320,"wires":[]},{"id":"54b7e03f.b54cc","type":"http request","z":"4f42a725.2ee548","name":"POST Pumps data","method":"POST","ret":"txt","paytoqs":"ignore","url":"https://lodicon-test-api.herokuapp.com/api/v1/-2147483551/ChrisKim/pumps","tls":"","persist":false,"proxy":"","authType":"","x":970,"y":500,"wires":[["194f35f7.4d8f3a"]]},{"id":"c87a7681.94ea48","type":"comment","z":"4f42a725.2ee548","name":"Feed object structure here","info":"","x":350,"y":80,"wires":[]},{"id":"cfe9dca6.781eb","type":"change","z":"4f42a725.2ee548","name":"Backwash_Pump_01 (dummy)","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"alarm\": \"No Alarm\",    \"name\": \"Backwash_Pump_01\",    \"real_time_flow\": 0.0,    \"real_time_pressure\": 0.0,    \"real_time_flow_unit\": \"m³\",    \"real_time_pressure_unit\": \"bar\",    \"status\": \"kakking\",    \"timestamp\": \"2021-07-09 09:01\",    \"total_flow\": 1,    \"total_flow_unit\": \"m³\",    \"valve_type\": \"backwash pump\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":200,"wires":[["3cf100c1.7f74d"]]},{"id":"9093532e.71629","type":"function","z":"4f42a725.2ee548","name":"Main_Pump_01: block_addr=2500","func":"msg.payload = {\n    alarm: 0,\n    real_time_flow: 0,\n    real_time_flow_unit: \"m³/h\",\n    real_time_pressure: 0,\n    real_time_pressure_unit: \"bar\",\n    status: 0,\n    total_flow: 1,\n    total_flow_unit: \"m³/h\",\n    valve_type: \"main pump\",\n    name: \"Main_Pump_01\",\n    timestamp: \"\"\n}\nmsg.block_addr = 2500;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":140,"wires":[["1d4bf085.45552f"]]},{"id":"1d4bf085.45552f","type":"subflow:8746f1d.d50691","z":"4f42a725.2ee548","name":"","env":[],"x":680,"y":140,"wires":[["3cf100c1.7f74d"]]},{"id":"3e6ca168.2a1b9e","type":"function","z":"8746f1d.d50691","name":"status","func":"const offset = 1;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 1\n}\nmsg.topic = 'status'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":100,"wires":[["f221c9c8.831858"]]},{"id":"b5549f2d.326a","type":"join","z":"ac8f238.cc942e","name":"Join into an Object (with topics as keys)","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"11","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":880,"y":340,"wires":[[]]},{"id":"6286cdd4.1ae584","type":"function","z":"ac8f238.cc942e","name":"Pass on other properties","func":"msg.payload = {\n    'name': msg.payload.name,\n    'timestamp': msg.payload.timestamp,\n    'unit': msg.payload.unit\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":340,"wires":[["b5f87c6b.4987d"]]},{"id":"f42cca48.09b9c8","type":"function","z":"ac8f238.cc942e","name":"alarm (MANUAL ADDR)","func":"// This property has its address manually set, rather than adding block_addr + offset\nconst addr = 200;\nmsg.payload = {\n    'fc': 1, //Reading as bit\n    'address': addr,\n    'quantity': 1\n}\nmsg.topic = 'alarm'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":80,"wires":[["691befff.fa2a1"]]},{"id":"691befff.fa2a1","type":"modbus-flex-getter","z":"ac8f238.cc942e","name":"","showStatusActivities":true,"showErrors":true,"logIOActivities":false,"server":"158a2db.8be95d2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":true,"x":530,"y":100,"wires":[["2e7dc51c.8bd96a"],[]]},{"id":"f6c508d7.ee02c8","type":"function","z":"ac8f238.cc942e","name":"average_value","func":"const offset = 2;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'average_value'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":200,"wires":[["691befff.fa2a1"]]},{"id":"5565b796.20d918","type":"function","z":"ac8f238.cc942e","name":"value","func":"const offset = 0;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'value'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":160,"wires":[["691befff.fa2a1"]]},{"id":"2e7dc51c.8bd96a","type":"switch","z":"ac8f238.cc942e","name":"Handle floats separately","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"value","vt":"str"},{"t":"eq","v":"average_value","vt":"str"},{"t":"eq","v":"setpoint","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":550,"y":180,"wires":[["13aacd8a.951952"],["13aacd8a.951952"],["13aacd8a.951952"],["f9030104.3d991"]]},{"id":"f9030104.3d991","type":"function","z":"ac8f238.cc942e","name":"Read INT / BIT Schneider","func":"msg.payload = 0 + msg.payload[0];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":200,"wires":[["b5549f2d.326a"]]},{"id":"13aacd8a.951952","type":"subflow:bc940a84.af93b8","z":"ac8f238.cc942e","name":"","env":[],"x":800,"y":160,"wires":[["e458c726.75bb58"]]},{"id":"64df3b1d.882644","type":"split","z":"ac8f238.cc942e","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":590,"y":340,"wires":[["b5549f2d.326a"]]},{"id":"e458c726.75bb58","type":"subflow:4609a12c.812e4","z":"ac8f238.cc942e","name":"","env":[],"x":990,"y":160,"wires":[["b5549f2d.326a"]]},{"id":"b5f87c6b.4987d","type":"subflow:f51a93c4.92157","z":"ac8f238.cc942e","name":"","env":[],"x":460,"y":340,"wires":[["64df3b1d.882644"]]},{"id":"60ab3a62.b6a864","type":"function","z":"ac8f238.cc942e","name":"setpoint (MANUAL ADDR)","func":"// This property has its address manually set, rather than adding block_addr + offset\nconst addr = 992;\nmsg.payload = {\n    'fc': 3,\n    'address': addr,\n    'quantity': 2\n}\nmsg.topic = 'setpoint'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":120,"wires":[["691befff.fa2a1"]]},{"id":"f9d28c59.096f3","type":"inject","z":"f4622989.27cb08","name":"EC Poller","props":[{"p":"payload"}],"repeat":"300","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":60,"wires":[["5052294e.b97ec8"]]},{"id":"aa738c66.6a7a2","type":"join","z":"f4622989.27cb08","name":"Join sequence into array","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"1","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":930,"y":360,"wires":[["b1bdf9a1.8536a8"]]},{"id":"cb553f32.1cd8a","type":"debug","z":"f4622989.27cb08","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1150,"y":460,"wires":[]},{"id":"b1bdf9a1.8536a8","type":"json","z":"f4622989.27cb08","name":"Format to JSON","property":"payload","action":"obj","pretty":true,"x":940,"y":420,"wires":[["cb553f32.1cd8a","152eb5d1.8fa2aa"]]},{"id":"4cc15a6d.0681e4","type":"comment","z":"f4622989.27cb08","name":"Set EC count here","info":"","x":910,"y":300,"wires":[]},{"id":"152eb5d1.8fa2aa","type":"http request","z":"f4622989.27cb08","name":"POST EC data","method":"POST","ret":"txt","paytoqs":"ignore","url":"https://lodicon-test-api.herokuapp.com/api/v1/-2147483551/ChrisKim/ec","tls":"","persist":false,"proxy":"","authType":"","x":980,"y":480,"wires":[["cb553f32.1cd8a"]]},{"id":"e2780f77.4d206","type":"comment","z":"f4622989.27cb08","name":"Feed object structure here","info":"","x":370,"y":60,"wires":[]},{"id":"5052294e.b97ec8","type":"function","z":"f4622989.27cb08","name":"Fertil1: block_addr=900","func":"msg.payload = {\n    \"alarm\": 0,\n    \"name\": \"Ferti1\",\n    \"value\": 0,\n    \"average_value\": 0,\n    \"unit\": \"mS\",\n    \"timestamp\": \"\",\n    \"setpoint\": 0\n}\nmsg.block_addr = 900;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":120,"wires":[["9ae09051.fafe4"]]},{"id":"9ae09051.fafe4","type":"subflow:ac8f238.cc942e","z":"f4622989.27cb08","name":"","x":630,"y":120,"wires":[["aa738c66.6a7a2"]]},{"id":"7f3f916b.9b5a8","type":"join","z":"ef3de703.f77228","name":"Join into an Object (with topics as keys)","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"10","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1060,"y":420,"wires":[[]]},{"id":"785ed13b.8ae71","type":"function","z":"ef3de703.f77228","name":"Pass on other properties","func":"msg.payload = {\n    'name': msg.payload.name,\n    'timestamp': msg.payload.timestamp,\n    'battery_level': msg.payload.battery_level\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":420,"wires":[["9bd3a334.b2fd9"]]},{"id":"c3214988.bcf398","type":"function","z":"ef3de703.f77228","name":"alarm (MANUAL ADDR)","func":"// This property has its address manually set, rather than adding block_addr + offset\nconst addr = 10;\nmsg.payload = {\n    'fc': 1,\n    'address': addr,\n    'quantity': 1\n}\nmsg.topic = 'alarm'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":120,"wires":[["6b7a4ba0.9fa2e4"]]},{"id":"6b7a4ba0.9fa2e4","type":"modbus-flex-getter","z":"ef3de703.f77228","name":"","showStatusActivities":true,"showErrors":true,"logIOActivities":false,"server":"158a2db.8be95d2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":true,"x":690,"y":120,"wires":[["1677adc8.080d12"],[]]},{"id":"97309c7f.40642","type":"function","z":"ef3de703.f77228","name":"backwash_time_left (MANUAL ADDR)","func":"//Set manual address becacuse it is not being used\nconst addr = 0;\nmsg.payload = {\n    'fc': 3,\n    'address': addr,\n    'quantity': 1\n}\nmsg.topic = 'backwash_time_left'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":320,"wires":[["6b7a4ba0.9fa2e4"]]},{"id":"62c8093d.a279b8","type":"function","z":"ef3de703.f77228","name":"irrigation_time_left","func":"const offset = 6;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'irrigation_time_left'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":280,"wires":[["6b7a4ba0.9fa2e4"]]},{"id":"1677adc8.080d12","type":"switch","z":"ef3de703.f77228","name":"Handle floats separately","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"backwash_status","vt":"str"},{"t":"eq","v":"alarm","vt":"str"},{"t":"eq","v":"irrigation_status","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":710,"y":200,"wires":[["b061618a.0d9cf"],["b061618a.0d9cf"],["b061618a.0d9cf"],["901b546c.8b7aa8"]]},{"id":"b061618a.0d9cf","type":"function","z":"ef3de703.f77228","name":"Read INT Schneider","func":"msg.payload = 0 + msg.payload[0];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":960,"y":180,"wires":[["7f3f916b.9b5a8"]]},{"id":"901b546c.8b7aa8","type":"subflow:bc940a84.af93b8","z":"ef3de703.f77228","name":"","env":[],"x":960,"y":220,"wires":[["1953cf24.c662f1"]]},{"id":"18a70472.a19c0c","type":"split","z":"ef3de703.f77228","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":650,"y":420,"wires":[["7f3f916b.9b5a8"]]},{"id":"1953cf24.c662f1","type":"subflow:4609a12c.812e4","z":"ef3de703.f77228","name":"","env":[],"x":1150,"y":220,"wires":[["7f3f916b.9b5a8"]]},{"id":"9bd3a334.b2fd9","type":"subflow:f51a93c4.92157","z":"ef3de703.f77228","name":"","env":[],"x":500,"y":420,"wires":[["18a70472.a19c0c"]]},{"id":"d93876b7.977f08","type":"function","z":"ef3de703.f77228","name":"irrigation_percentage_left","func":"const offset = 2;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'irrigation_percentage_left'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":240,"wires":[["6b7a4ba0.9fa2e4"]]},{"id":"80be9bc.6136468","type":"function","z":"ef3de703.f77228","name":"irrigation_status (MANUAL_ADDR)","func":"// This property has its address manually set, rather than adding block_addr + offset\nconst addr  = 11;\nmsg.payload = {\n    'fc': 1,\n    'address': addr,\n    'quantity': 1\n}\nmsg.topic = 'irrigation_status'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":160,"wires":[["6b7a4ba0.9fa2e4"]]},{"id":"f9bdf815.640348","type":"function","z":"ef3de703.f77228","name":"backwash_status (MANUAL ADDR)","func":"// This property has its address manually set, rather than adding block_addr + offset\nconst addr = 9;\nmsg.payload = {\n    'fc': 1,\n    'address': addr,\n    'quantity': 1\n}\nmsg.topic = 'backwash_status'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":80,"wires":[["6b7a4ba0.9fa2e4"]]},{"id":"66530530.6485bc","type":"function","z":"ef3de703.f77228","name":"backwash_percentage_left","func":"const offset = 0;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'backwash_percentage_left'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":200,"wires":[["6b7a4ba0.9fa2e4"]]},{"id":"4d2e2ba6.3404b4","type":"inject","z":"12f51354.988b8d","name":"Irrigation Status Poller","props":[{"p":"payload"}],"repeat":"300","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":80,"wires":[["de2b2e1.13180d"]]},{"id":"7bea82a1.b3887c","type":"debug","z":"12f51354.988b8d","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":730,"y":320,"wires":[]},{"id":"5adf9cd8.db7da4","type":"json","z":"12f51354.988b8d","name":"Format to JSON","property":"payload","action":"obj","pretty":true,"x":420,"y":260,"wires":[["a0505703.2a6388","7bea82a1.b3887c"]]},{"id":"a0505703.2a6388","type":"http request","z":"12f51354.988b8d","name":"POST Irrigation data","method":"POST","ret":"txt","paytoqs":"ignore","url":"https://lodicon-test-api.herokuapp.com/api/v1/-2147483551/ChrisKim/status","tls":"","persist":false,"proxy":"","authType":"","x":480,"y":320,"wires":[["7bea82a1.b3887c"]]},{"id":"dda2a64e.7c7f48","type":"comment","z":"12f51354.988b8d","name":"Feed object structure here","info":"","x":370,"y":80,"wires":[]},{"id":"de2b2e1.13180d","type":"function","z":"12f51354.988b8d","name":"Glen Heatlie: block_addr=1930","func":"msg.payload = {\n\n    \"name\":\"Glen heatlie\",\n\n    \"irrigation_status\": 0,\n\n    \"irrigation_time_left\": 0,\n\n    \"irrigation_percentage_left\": 0,\n\n    \"backwash_status\": 0,\n\n    \"backwash_time_left\": 0,\n\n    \"backwash_percentage_left\": 0,\n\n    \"timestamp\": \"\",\n\n    \"battery_level\": 80.1,\n\n    \"alarm\": 0\n\n}\nmsg.block_addr = 1930;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":140,"wires":[["d3b12408.0effe8"]]},{"id":"d3b12408.0effe8","type":"subflow:ef3de703.f77228","z":"12f51354.988b8d","name":"","x":420,"y":200,"wires":[["5adf9cd8.db7da4"]]},{"id":"cd2b8627.23d428","type":"function","z":"f51a93c4.92157","name":"Set timestamp with local timezone (YYYY-mm-dd hh:mm:ss)","func":"// Retrieved from https://stackoverflow.com/questions/10830357/javascript-toisostring-ignores-timezone-offset\nvar tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds;\nvar time = (new Date(Date.now() - tzoffset)).toISOString().slice(0, -1);\ntime = time.replace('T', ' '); // Remove T from time format\ntime = time.replace(/\\..+/, '') // Remove all numbers after a dot (i.e. microseconds)\n\nmsg.payload.timestamp = time;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":140,"wires":[[]]},{"id":"99cced0f.12b3b","type":"join","z":"62fba3f4.438d0c","name":"Join into an Object (merge)","mode":"custom","build":"merged","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"10","count":"23","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":900,"y":380,"wires":[[]]},{"id":"4df57c32.d68514","type":"function","z":"62fba3f4.438d0c","name":"Pass on other properties","func":"var payload = {\n    'total_water_unit': msg.payload.total_water_unit,\n    'timestamp': msg.timestamp\n}\nfor (let i=1; i<=5; i++){\n    payload['total_fertilizer0'+i+'_unit'] = msg.payload['total_fertilizer0'+i+'_unit']\n    payload['total_placeholder0'+i+'_unit'] = msg.payload['total_placeholder0'+i+'_unit']\n}\nmsg.payload = payload;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":380,"wires":[["609ca569.ea200c"]]},{"id":"609ca569.ea200c","type":"subflow:f51a93c4.92157","z":"62fba3f4.438d0c","name":"","env":[],"x":420,"y":380,"wires":[["99cced0f.12b3b"]]},{"id":"ff1c45a4.ebf858","type":"function","z":"62fba3f4.438d0c","name":"total_water_flow","func":"const offset = 0;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'total_water_flow'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":100,"wires":[["cf481481.7ba198"]]},{"id":"1e717f04.c52ee1","type":"function","z":"62fba3f4.438d0c","name":"total_fertilizerXX","func":"msg.attribute_offset = 2;\nmsg.label = [\"total_fertilizer\", \"_flow\"];\nmsg.float_count = 5\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":140,"wires":[["b151f60d.361638"]]},{"id":"ed3c7a18.b52398","type":"function","z":"62fba3f4.438d0c","name":"total_placeholderXX","func":"msg.attribute_offset = 22;\nmsg.label = [\"total_placeholder\", \"_flow\"];\nmsg.float_count = 5\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":180,"wires":[["f57a5f26.4208a"]]},{"id":"f7cd675.c98c298","type":"function","z":"62fba3f4.438d0c","name":"Label","func":"msg.payload = {\n    total_water_flow: msg.payload\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":100,"wires":[["99cced0f.12b3b"]]},{"id":"6ec4fd73.ba20f4","type":"function","z":"25f303f4.02b02c","name":"Modbus overhead","func":"msg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + msg.attribute_offset,\n    'quantity': msg.float_count * 2\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":80,"wires":[["60124203.f4a13c"]]},{"id":"60124203.f4a13c","type":"modbus-flex-getter","z":"25f303f4.02b02c","name":"","showStatusActivities":true,"showErrors":true,"logIOActivities":false,"server":"158a2db.8be95d2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":true,"x":330,"y":140,"wires":[["d7305bb3.f69708"],[]]},{"id":"d7305bb3.f69708","type":"function","z":"25f303f4.02b02c","name":"Parse into floats and label","func":"const intArray = msg.payload;\nmsg.payload = {}\nfor (let i=0; i < intArray.length-1; i+=2){\n    let index = \"\";\n    if (i/2 + 1 < 10){\n        index = \"0\" + (i/2 + 1);\n    }\n    else{\n        index = \"\" + (i/2 + 1);\n    }\n    let key = msg.label[0].concat(index, msg.label[1]);\n    let [x, y] = [intArray[i], intArray[i + 1]];\n    \n    // Create a buffer\n    let buf = new ArrayBuffer(4);\n    // Create a 16-bit int view of it\n    let ints = new Uint16Array(buf);\n    // Fill in the values\n    ints[0] = x;\n    ints[1] = y;\n    // Create a 32-bit float view of it\n    let floats = new Float32Array(buf);\n    \n    msg.payload[key] = Math.round(floats[0] * 1000) / 1000;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":200,"wires":[[]]},{"id":"b151f60d.361638","type":"subflow:25f303f4.02b02c","z":"62fba3f4.438d0c","name":"","env":[],"x":440,"y":140,"wires":[["99cced0f.12b3b"]]},{"id":"f57a5f26.4208a","type":"subflow:25f303f4.02b02c","z":"62fba3f4.438d0c","name":"","x":440,"y":180,"wires":[["99cced0f.12b3b"]]},{"id":"b09835e9.b6e598","type":"inject","z":"c871d85e.04b1b8","name":"Water Usage Poller","props":[{"p":"payload"}],"repeat":"300","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":160,"y":60,"wires":[["afba0c14.8d356"]]},{"id":"ef577555.7b2308","type":"debug","z":"c871d85e.04b1b8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":790,"y":260,"wires":[]},{"id":"61491a7d.aba114","type":"json","z":"c871d85e.04b1b8","name":"Format to JSON","property":"payload","action":"obj","pretty":true,"x":440,"y":240,"wires":[["ef577555.7b2308","ff6a0ce2.e8dfa"]]},{"id":"ff6a0ce2.e8dfa","type":"http request","z":"c871d85e.04b1b8","name":"POST Water usage data","method":"POST","ret":"txt","paytoqs":"ignore","url":"https://lodicon-test-api.herokuapp.com/api/v1/-2147483551/ChrisKim/water_usage","tls":"","persist":false,"proxy":"","authType":"","x":510,"y":300,"wires":[["ef577555.7b2308"]]},{"id":"5ace258a.802a4c","type":"comment","z":"c871d85e.04b1b8","name":"Feed object structure here","info":"","x":390,"y":60,"wires":[]},{"id":"afba0c14.8d356","type":"function","z":"c871d85e.04b1b8","name":"block_addr=1900","func":"msg.payload = {\n    \n    \"timestamp\": \"\",\n\n    \"total_water_flow\": 0,\n\n    \"total_water_unit\": \"m³\",\n\n    \"total_fertilizer01_flow\": 0,\n\n    \"total_fertilizer01_unit\": \"l\",\n\n    \"total_fertilizer02_flow\": 0,\n\n    \"total_fertilizer02_unit\": \"l\",\n\n    \"total_fertilizer03_flow\": 0,\n\n    \"total_fertilizer03_unit\": \"l\",\n\n    \"total_fertilizer04_flow\": 0,\n\n    \"total_fertilizer04_unit\": \"l\",\n\n    \"total_fertilizer05_flow\": 0,\n\n    \"total_fertilizer05_unit\": \"l\",\n\n    \"total_placeholder01_flow\": 0,\n\n    \"total_placeholder01_unit\": \"l\",\n\n    \"total_placeholder02_flow\": 0,\n\n    \"total_placeholder02_unit\": \"l\",\n\n    \"total_placeholder03_flow\": 0,\n\n    \"total_placeholder03_unit\": \"l\",\n\n    \"total_placeholder04_flow\": 0,\n\n    \"total_placeholder04_unit\": \"l\",\n\n    \"total_placeholder05_flow\": 0,\n\n    \"total_placeholder05_unit\": \"l\"\n\n\n}\nmsg.block_addr = 1900;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":120,"wires":[["f7e15a05.3230b8"]]},{"id":"f7e15a05.3230b8","type":"subflow:62fba3f4.438d0c","z":"c871d85e.04b1b8","name":"","env":[],"x":440,"y":180,"wires":[["61491a7d.aba114"]]},{"id":"8b90efa8.0b9a5","type":"comment","z":"83261835.d8a0a8","name":"Block unless value changes","info":"RBE is used because so many values are being written and it is unnecessary to write the same values every few seconds.","x":280,"y":140,"wires":[]},{"id":"1e3aa4c5.78244b","type":"comment","z":"83261835.d8a0a8","name":"set block_addr to wherever these BLOCKs are","info":"For example, Eureka's values can be found starting fomr %MW1000, and it is BLOCK1, so we set its msg.block_addr to 1000.","x":330,"y":180,"wires":[]},{"id":"5da34390.b4e0fc","type":"comment","z":"a2d35a2c.16ee18","name":"Go to [host ip]/ui to edit configuration fields","info":"You can bookmark this url for easy access.","x":220,"y":60,"wires":[]},{"id":"723d6063.d7107","type":"comment","z":"1466200c.ef10b","name":"Each property of the object is set an attribute_offset. Address is calculated by adding the block address (starting address of the block) to this offset.","info":"","x":520,"y":100,"wires":[]},{"id":"46f034d3.9511ac","type":"comment","z":"ad856da8.1809a","name":"Each property of the object is set an offset. Address is calculated by adding the block address (starting address of the block) to this offset.","info":"","x":500,"y":200,"wires":[]},{"id":"c4499fe1.4558a","type":"comment","z":"8746f1d.d50691","name":"Each property of the object is set an offset. Address is calculated by adding the block address (starting address of the block) to this offset.","info":"","x":500,"y":20,"wires":[]},{"id":"7f27dffb.bd436","type":"comment","z":"25f303f4.02b02c","name":"Subflow to read a series of floats at a certain address (see more inside)","info":"The property names of these floats may be structured, for example, as follows:\n\n\"total_fertilizer01_flow\"\nranging to\n\"total_fertilizer15_flow\"\n\nThis subflow requires the following arguments:\n- msg.label: a two-item array. In this case label[0] = \"total_fertilizer\" and label[1] = \"_flow\". These are joined to the number in between at the end.\n- msg.float_count: The number of floats to read. In this case it is 15.\n- msg.block_addr and msg.offset are used the same way as in other flows to find the address of our values.\n\nAfter reading from the Modbus an array of integers, each pair of integers is converted to a float. The subflow outputs an object with properties. The keys of these properties are for example \"total_fertilizer_xx_flow\" and the value is the xxth float.","x":330,"y":20,"wires":[]},{"id":"82bcee74.232a9","type":"comment","z":"4609a12c.812e4","name":"Rounding out a float read","info":"This is necessary because when we read from the Modbus a pair of integers and then convert them to float, the float is off by a tiny amount, making a long decimal number which is ugly to store. I therefore round them out to 3 decimal places.","x":250,"y":80,"wires":[]},{"id":"2865cdac.d49fc2","type":"comment","z":"5c362c3f.f14494","name":"A reusable subflow to format and write date (details inside)","info":"The input date is parsed into year, month, day, hour, and minute. We write each of these integers into a sequence of words.\n\nWe calculate the address with the inputs msg.block_addr and msg.attribute_offset. These two values are added to get the address. ","x":260,"y":20,"wires":[]},{"id":"77df91ba.95ee7","type":"comment","z":"689c1364.c8ce1c","name":"Regularly checks PLC's real-time clock against gateway","info":"","x":220,"y":40,"wires":[]},{"id":"6e109063.e7b6d","type":"inject","z":"689c1364.c8ce1c","name":"Repeat every 1 minute","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":100,"wires":[["7c1b104c.b8196"]]},{"id":"7d4ed2c9.8670fc","type":"debug","z":"689c1364.c8ce1c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":830,"y":480,"wires":[]},{"id":"d9cf6b95.4871a8","type":"function","z":"689c1364.c8ce1c","name":"Write date only if different from system time","func":"const dateNow = new Date();\nconst dateArray = [\n    dateNow.getDate(),\n    dateNow.getMonth() + 1,\n    dateNow.getFullYear(),\n    dateNow.getHours(),\n    dateNow.getMinutes(),\n    dateNow.getSeconds()\n]\n\n// Stringify arrays so we can compare them easily\nif (JSON.stringify(msg.payload) != JSON.stringify(dateArray)) {\n    msg.payload = dateArray;\n    return msg; \n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":400,"wires":[["6ddbb393.46d5bc","7d4ed2c9.8670fc"]]},{"id":"6ddbb393.46d5bc","type":"function","z":"689c1364.c8ce1c","name":"Modbus overhead","func":"msg.block_addr = 0;\nmsg.payload = {\n    value: msg.payload,\n    'fc': 16,\n    'address': msg.block_addr,\n    'quantity': 6\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":460,"wires":[["674aad08.5b5874"]]},{"id":"49c509fc.5952c8","type":"function","z":"689c1364.c8ce1c","name":"Modbus overhead","func":"msg.block_addr = 6;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr,\n    'quantity': 6\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":280,"wires":[["ad6e8713.32f038"]]},{"id":"ad6e8713.32f038","type":"modbus-flex-getter","z":"689c1364.c8ce1c","name":"Read Dates [D, M, Y, h, m, s]","showStatusActivities":false,"showErrors":false,"logIOActivities":false,"server":"158a2db.8be95d2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":false,"x":320,"y":340,"wires":[["d9cf6b95.4871a8","7d4ed2c9.8670fc"],[]]},{"id":"674aad08.5b5874","type":"modbus-flex-write","z":"689c1364.c8ce1c","name":"Write Dates [D, M, Y, h, m, s]","showStatusActivities":true,"showErrors":true,"server":"158a2db.8be95d2","emptyMsgOnFail":false,"keepMsgProperties":false,"x":440,"y":520,"wires":[["12e339a2.293a96"],[]]},{"id":"34b3e3fd.faa5dc","type":"inject","z":"689c1364.c8ce1c","name":"Repeat every day","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 12 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":780,"wires":[["3e2c64dc.6bdb3c"]]},{"id":"3e2c64dc.6bdb3c","type":"http request","z":"689c1364.c8ce1c","name":"GET internet time","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://worldtimeapi.org/api/timezone/Africa/Johannesburg","tls":"","persist":false,"proxy":"","authType":"","x":190,"y":840,"wires":[["c05e8f94.dd4dd"]]},{"id":"343c387e.1337f8","type":"debug","z":"689c1364.c8ce1c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":590,"y":880,"wires":[]},{"id":"c05e8f94.dd4dd","type":"json","z":"689c1364.c8ce1c","name":"Parse JSON","property":"payload","action":"obj","pretty":false,"x":210,"y":900,"wires":[["fa628a1c.062d58","343c387e.1337f8"]]},{"id":"fa628a1c.062d58","type":"function","z":"689c1364.c8ce1c","name":"If different from system time by a few seconds,","func":"let internetDate = msg.payload.unixtime;\nlet systemDate = new Date().getTime() / 1000;\nlet diff = Math.abs(internetDate - systemDate)\nif (diff > 10) {\n    //if difference between times is greater than 10 seconds\n    msg.payload = internetDate;\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":960,"wires":[["343c387e.1337f8","2f3e722a.d5968e"]]},{"id":"2f3e722a.d5968e","type":"exec","z":"689c1364.c8ce1c","command":"date +%s -s @","addpay":"payload","append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Set system time to Unix timestamp","x":360,"y":1020,"wires":[[],[],[]]},{"id":"753f5541.52504c","type":"modbus-write","z":"689c1364.c8ce1c","name":"Set Write Bit to 0","showStatusActivities":true,"showErrors":true,"unitid":"","dataType":"Coil","adr":"500","quantity":"1","server":"158a2db.8be95d2","emptyMsgOnFail":false,"keepMsgProperties":false,"x":210,"y":220,"wires":[["49c509fc.5952c8"],[]]},{"id":"7c1b104c.b8196","type":"function","z":"689c1364.c8ce1c","name":"Set Write Bit to 0","func":"msg.payload = 0;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":160,"wires":[["753f5541.52504c"]]},{"id":"3865e16.40b8c1e","type":"function","z":"4e66368c.aa1338","name":"Set Buffer Bit to 1","func":"msg.payload = 1;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":140,"wires":[["67a15a31.10b5e4"]]},{"id":"67a15a31.10b5e4","type":"modbus-write","z":"4e66368c.aa1338","name":"Set Buffer Bit to 1","showStatusActivities":true,"showErrors":true,"unitid":"","dataType":"Coil","adr":"501","quantity":"1","server":"158a2db.8be95d2","emptyMsgOnFail":false,"keepMsgProperties":false,"x":390,"y":200,"wires":[["8d0a6382.bc844"],[]]},{"id":"2082628a.2a26de","type":"function","z":"4e66368c.aa1338","name":"Set Write Bit to 0","func":"msg.payload = 0;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":380,"wires":[["6cace057.b34a"]]},{"id":"6cace057.b34a","type":"modbus-write","z":"4e66368c.aa1338","name":"Set Write Bit to 0","showStatusActivities":true,"showErrors":true,"unitid":"","dataType":"Coil","adr":"500","quantity":"1","server":"158a2db.8be95d2","emptyMsgOnFail":false,"keepMsgProperties":false,"x":550,"y":440,"wires":[["d7f48b5f.554968"],[]]},{"id":"8d0a6382.bc844","type":"function","z":"4e66368c.aa1338","name":"Set Write Bit to 1","func":"msg.payload = 1;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":260,"wires":[["f5684a29.a809c8"]]},{"id":"f5684a29.a809c8","type":"modbus-write","z":"4e66368c.aa1338","name":"Set Write Bit to 1","showStatusActivities":true,"showErrors":true,"unitid":"","dataType":"Coil","adr":"500","quantity":"1","server":"158a2db.8be95d2","emptyMsgOnFail":false,"keepMsgProperties":false,"x":470,"y":320,"wires":[["2082628a.2a26de"],[]]},{"id":"d7f48b5f.554968","type":"function","z":"4e66368c.aa1338","name":"Set Buffer Bit to 0","func":"msg.payload = 0;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":500,"wires":[["cf7d65db.f3ee38"]]},{"id":"cf7d65db.f3ee38","type":"modbus-write","z":"4e66368c.aa1338","name":"Set Buffer Bit to 0","showStatusActivities":true,"showErrors":true,"unitid":"","dataType":"Coil","adr":"501","quantity":"1","server":"158a2db.8be95d2","emptyMsgOnFail":false,"keepMsgProperties":false,"x":630,"y":560,"wires":[[],[]]},{"id":"12e339a2.293a96","type":"subflow:4e66368c.aa1338","z":"689c1364.c8ce1c","name":"","env":[],"x":470,"y":580,"wires":[[]]},{"id":"29a9c98a.b40026","type":"modbus-read","z":"43378544.406b5c","name":"Eureka irrigation complete alert: address=90","topic":"","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"unitid":"","dataType":"HoldingRegister","adr":"90","quantity":"1","rate":"1","rateUnit":"s","delayOnStart":false,"startDelayTime":"","server":"158a2db.8be95d2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":310,"y":120,"wires":[["ffad236c.53bac"],[]]},{"id":"96c66f5b.823f4","type":"function","z":"43378544.406b5c","name":"Alert if value is 1; also set msg.topic to farm name","func":"if (msg.payload == 1) {\n    msg.topic = 'Eureka';\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":240,"wires":[["e81f72ae.f8f86","e497c3ac.8284"]]},{"id":"e81f72ae.f8f86","type":"debug","z":"43378544.406b5c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":870,"y":240,"wires":[]},{"id":"f115ed1f.a8898","type":"join","z":"f49ec726.13c968","name":"Join into an Object (with topics as keys)","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"11","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1060,"y":420,"wires":[[]]},{"id":"6b0828e4.9a6fa8","type":"function","z":"f49ec726.13c968","name":"Pass on other properties","func":"// Retrieved from https://stackoverflow.com/questions/10830357/javascript-toisostring-ignores-timezone-offset\nvar tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds;\nvar time = (new Date(Date.now() - tzoffset)).toISOString().slice(0, -1);\ntime = time.replace('T', ' '); // Remove T from time format\ntime = time.replace(/\\..+/, '') // Remove all numbers after a dot (i.e. microseconds)\n\nmsg.payload = {\n    'LocationDescription': msg.payload.LocationDescription,\n    'BlockID': msg.payload.BlockID,\n    'ValveDescription': msg.payload.ValveDescription,\n    'ValveID': msg.payload.ValveID,\n    'TimeStamp': time\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":420,"wires":[["817e33e6.a59e7"]]},{"id":"b8810245.80945","type":"function","z":"f49ec726.13c968","name":"AverageMainLineFlowRateM3_H","func":"const offset = 0;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'AverageMainLineFlowRateM3_H';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":160,"wires":[["86dd80ab.22aa4"]]},{"id":"86dd80ab.22aa4","type":"modbus-flex-getter","z":"f49ec726.13c968","name":"","showStatusActivities":true,"showErrors":true,"logIOActivities":false,"server":"158a2db.8be95d2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":true,"x":610,"y":180,"wires":[["e38392dc.e6d11"],[]]},{"id":"6c391ca5.5ec964","type":"function","z":"f49ec726.13c968","name":"AverageMainLinePressure","func":"const offset = 2;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'AverageMainLinePressure'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":200,"wires":[["86dd80ab.22aa4"]]},{"id":"22f15191.08808e","type":"function","z":"f49ec726.13c968","name":"TotalMainLineFlowM3","func":"const offset = 6;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'TotalMainLineFlowM3'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":280,"wires":[["86dd80ab.22aa4"]]},{"id":"af17afc4.10738","type":"function","z":"f49ec726.13c968","name":"CalculatedMM","func":"const offset = 4;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'CalculatedMM'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":240,"wires":[["86dd80ab.22aa4"]]},{"id":"e38392dc.e6d11","type":"switch","z":"f49ec726.13c968","name":"Handle floats separately","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"RuntimeMins","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":260,"wires":[["828d9d9c.b0804"],["f0e01923.eb6d68"]]},{"id":"828d9d9c.b0804","type":"function","z":"f49ec726.13c968","name":"Read INT Schneider","func":"msg.payload = msg.payload[0];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":240,"wires":[["f115ed1f.a8898"]]},{"id":"f0e01923.eb6d68","type":"subflow:bc940a84.af93b8","z":"f49ec726.13c968","name":"","env":[],"x":920,"y":280,"wires":[["44c8366b.678048"]]},{"id":"817e33e6.a59e7","type":"split","z":"f49ec726.13c968","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":610,"y":420,"wires":[["f115ed1f.a8898"]]},{"id":"44c8366b.678048","type":"subflow:4609a12c.812e4","z":"f49ec726.13c968","name":"","env":[],"x":1110,"y":280,"wires":[["f115ed1f.a8898"]]},{"id":"d8911a3a.7669d8","type":"function","z":"f49ec726.13c968","name":"TotalValveFlowM3","func":"const offset = 8;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 2\n}\nmsg.topic = 'TotalValveFlowM3'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":320,"wires":[["86dd80ab.22aa4"]]},{"id":"ca5e8aac.457338","type":"function","z":"f49ec726.13c968","name":"RuntimeMins","func":"const offset = 10;\nmsg.payload = {\n    'fc': 3,\n    'address': msg.block_addr + offset,\n    'quantity': 1\n}\nmsg.topic = 'RuntimeMins'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":360,"wires":[["86dd80ab.22aa4"]]},{"id":"f7916dca.c656a","type":"inject","z":"f4386468.5ef998","name":"inject","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":90,"y":100,"wires":[["b80cdb5a.f0caa8","4f6b76b7.f164f8"]]},{"id":"dd8927c0.b033c8","type":"join","z":"f4386468.5ef998","name":"Join sequence into array","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":770,"y":460,"wires":[["d57179a6.780fb8"]]},{"id":"dbde9de3.b1a7","type":"debug","z":"f4386468.5ef998","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1170,"y":620,"wires":[]},{"id":"d57179a6.780fb8","type":"json","z":"f4386468.5ef998","name":"Format to JSON","property":"payload","action":"obj","pretty":true,"x":780,"y":520,"wires":[["2759cca5.9e0094"]]},{"id":"cf8f8782.7139b8","type":"comment","z":"f4386468.5ef998","name":"Set total valve count here","info":"","x":770,"y":400,"wires":[]},{"id":"dad73d80.78c69","type":"comment","z":"f4386468.5ef998","name":"Feed object structure here","info":"","x":270,"y":160,"wires":[]},{"id":"b80cdb5a.f0caa8","type":"function","z":"f4386468.5ef998","name":"Valve 1: block_addr=5000","func":"msg.payload = {\n    \"AverageMainLineFlowRateM3_H\": 0,\n    \n    \"AverageMainLinePressure\": 0,\n    \n    \"BlockID\": \"-2147472851\",\n    \n    \"CalculatedMM\": 0,\n    \n    \"LocationDescription\": \" Eureka\",\n    \n    \"RuntimeMins\": 0,\n    \n    \"TimeStamp\": \"\",\n    \n    \"TotalMainLineFlowM3\": 0,\n    \n    \"TotalValveFlowM3\": 0,\n    \n    \"ValveDescription\": \"Valve 1\",\n    \n    \"ValveID\": \"-2147472851\"\n};\nmsg.block_addr = 5000;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":220,"wires":[["acc7cf9c.8b683"]]},{"id":"acc7cf9c.8b683","type":"subflow:f49ec726.13c968","z":"f4386468.5ef998","name":"","env":[],"x":550,"y":220,"wires":[["dd8927c0.b033c8"]]},{"id":"4f6b76b7.f164f8","type":"function","z":"f4386468.5ef998","name":"Valve 2: block_addr=5020","func":"msg.payload = {\n    \"AverageMainLineFlowRateM3_H\": 0,\n    \n    \"AverageMainLinePressure\": 0,\n    \n    \"BlockID\": \"-2147472851\",\n    \n    \"CalculatedMM\": 0,\n    \n    \"LocationDescription\": \" Eureka\",\n    \n    \"RuntimeMins\": 0,\n    \n    \"TimeStamp\": \"\",\n    \n    \"TotalMainLineFlowM3\": 0,\n    \n    \"TotalValveFlowM3\": 0,\n    \n    \"ValveDescription\": \"Valve 2\",\n    \n    \"ValveID\": \"-2147472851\"\n};\nmsg.block_addr = 5020;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":260,"wires":[["3a502db4.bf7a82"]]},{"id":"3a502db4.bf7a82","type":"subflow:f49ec726.13c968","z":"f4386468.5ef998","name":"","env":[],"x":550,"y":260,"wires":[["dd8927c0.b033c8"]]},{"id":"2759cca5.9e0094","type":"function","z":"f4386468.5ef998","name":"Format message and set Gateway ID","func":"// Retrieved from https://stackoverflow.com/questions/10830357/javascript-toisostring-ignores-timezone-offset\nvar tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds;\nvar time = (new Date(Date.now() - tzoffset)).toISOString().slice(0, -1);\ntime = time.replace('T', ' '); // Remove T from time format\ntime = time.replace(/\\..+/, '') // Remove all numbers after a dot (i.e. microseconds)\n\nmsg.payload = {\n    'gateway_data': {\n        'gateway_id': \"MyFirstGateway\",\n        'timestamp': time\n    },\n    'logged_irrigation_data': msg.payload\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":580,"wires":[["dbde9de3.b1a7","6edd78e8.3a5178"]]},{"id":"6edd78e8.3a5178","type":"http request","z":"f4386468.5ef998","name":"POST Irrigation data","method":"POST","ret":"txt","paytoqs":"ignore","url":"https://lodicon-test-api.herokuapp.com/api/v1/2147483551/gateway_id/irrigation","tls":"","persist":false,"proxy":"","authType":"","x":880,"y":640,"wires":[["dbde9de3.b1a7","584abf93.a82bd"]]},{"id":"ffad236c.53bac","type":"rbe","z":"43378544.406b5c","name":"Only pass if value changes","func":"rbe","gap":"","start":"","inout":"out","septopics":true,"property":"payload","x":300,"y":180,"wires":[["96c66f5b.823f4"]]},{"id":"2f94446f.2662cc","type":"link in","z":"f4386468.5ef998","name":"","links":["e497c3ac.8284","9ce3eb28.e9a0a8"],"x":55,"y":220,"wires":[["b80cdb5a.f0caa8","4f6b76b7.f164f8"]]},{"id":"8a873284.767d6","type":"comment","z":"ac8f238.cc942e","name":"Each property of the object is set an offset. Address is calculated by adding the block address (starting address of the block) to this offset.","info":"","x":540,"y":40,"wires":[]},{"id":"62796b8f.722624","type":"comment","z":"f49ec726.13c968","name":"Each property of the object is set an offset. Address is calculated by adding the block address (starting address of the block) to this offset.","info":"","x":520,"y":80,"wires":[]},{"id":"8d9d96cb.39d9a8","type":"comment","z":"62fba3f4.438d0c","name":"Each property of the object is set an offset. Address is calculated by adding the block address (starting address of the block) to this offset.","info":"","x":520,"y":40,"wires":[]},{"id":"5bfc2968.d54bc8","type":"comment","z":"ef3de703.f77228","name":"Each property of the object is set an offset. Address is calculated by adding the block address (starting address of the block) to this offset.","info":"","x":520,"y":40,"wires":[]},{"id":"b3b128cb.ee4768","type":"comment","z":"689c1364.c8ce1c","name":"Occasionally checks Pi's system time against the Internet","info":"","x":270,"y":720,"wires":[]},{"id":"51f16574.26304c","type":"comment","z":"43378544.406b5c","name":"Regularly reads this alert bit. Add a set of these nodes for each bit to monitor.","info":"","x":390,"y":60,"wires":[]},{"id":"2eacdf9a.ab194","type":"comment","z":"f4386468.5ef998","name":"Add a link-in for each farm; Add a function object which sets block_addr for each valve in the farm.","info":"","x":350,"y":40,"wires":[]},{"id":"3fc4fe81.f33292","type":"comment","z":"4e66368c.aa1338","name":"Click for explanation","info":"- Raise to 1 the “buffer bit” in the PLC, which makes the PLC write the values in the memory to its RTC\n- Raise to 1 the “write bit” in the PLC, which makes the changes to the RTC persistent\n- Lower to 0 the “write bit”\n- Lower to 0 the “buffer bit”, which makes the PLC no longer write values into the RTC\n","x":230,"y":60,"wires":[]},{"id":"2e1e72f5.d817ee","type":"subflow:bc940a84.af93b8","z":"62fba3f4.438d0c","name":"","env":[],"x":640,"y":100,"wires":[["f7cd675.c98c298"]]},{"id":"cf481481.7ba198","type":"modbus-flex-getter","z":"62fba3f4.438d0c","name":"","showStatusActivities":false,"showErrors":false,"logIOActivities":false,"server":"158a2db.8be95d2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"keepMsgProperties":false,"x":430,"y":100,"wires":[["2e1e72f5.d817ee"],[]]},{"id":"584abf93.a82bd","type":"switch","z":"f4386468.5ef998","name":"If / if not successful","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":910,"y":700,"wires":[["24ac6029.f859f"],["bf494d44.8ca8a"]]},{"id":"24ac6029.f859f","type":"function","z":"f4386468.5ef998","name":"Set alert bit to 0","func":"logged_complete_bit_addr = {\n    'Eureka': 90\n}\n\nmsg.payload = {\n    value: 0,\n    'fc': 1,\n    'address': logged_complete_bit_addr[msg.topic],\n    'quantity': 1\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":760,"wires":[["88985b46.cd1058"]]},{"id":"e497c3ac.8284","type":"link out","z":"43378544.406b5c","name":"Eureka logged irrigation complete","links":["2f94446f.2662cc"],"x":275,"y":300,"wires":[]},{"id":"60260319.49bb3c","type":"switch","z":"f4386468.5ef998","name":"If unsuccessful, go back to start","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"Eureka","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1030,"y":920,"wires":[["9ce3eb28.e9a0a8"]]},{"id":"bf494d44.8ca8a","type":"delay","z":"f4386468.5ef998","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":920,"y":880,"wires":[["60260319.49bb3c"]]},{"id":"9ce3eb28.e9a0a8","type":"link out","z":"f4386468.5ef998","name":"","links":["2f94446f.2662cc"],"x":1195,"y":920,"wires":[]},{"id":"88985b46.cd1058","type":"modbus-flex-write","z":"f4386468.5ef998","name":"","showStatusActivities":true,"showErrors":true,"server":"158a2db.8be95d2","emptyMsgOnFail":false,"keepMsgProperties":false,"x":990,"y":800,"wires":[["dbde9de3.b1a7"],[]]}]